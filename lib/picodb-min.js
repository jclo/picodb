/**
 * PicoDB v0.2.0
 *
 * @license
 * PicoDB is a tiny in-memory database that stores JSON documents.
 * Copyright (c) 2016 jclo <jclo@mobilabs.fr> (http://www.mobilabs.fr/).
 * Released under the MIT license. You may obtain a copy of the License
 * at: http://www.opensource.org/licenses/mit-license.php).
 */
!function(e,t){"use strict";"function"==typeof define&&define.amd?define([""],t):"object"==typeof exports?module.exports=t(e):e.PicoDB=t(e)}(this,function(e){"use strict";var t,n;n=e.PicoDB,t=function(){},t.noConflict=function(){return e.PicoDB=n,this},t.VERSION="0.2.0";var r={};r={isUndefined:function(e){return void 0===e},isNull:function(e){return null===e},isBoolean:function(e){return e===!0||e===!1||"[object Boolean]"===Object.prototype.toString.call(e)},isString:function(e){return"[object String]"===Object.prototype.toString.call(e)},isNumber:function(e){return"[object Number]"===Object.prototype.toString.call(e)},isNaN:function(e){return r.isNumber(e)&&e!==+e},isOdd:function(e){var t=e%2;return e===parseFloat(e)?!!t:void 0},isObject:function(e){var t=typeof e;return"function"===t||"object"===t&&!!e},isMath:function(e){return"[object Math]"===Object.prototype.toString.call(e)},isDate:function(e){return"[object Date]"===Object.prototype.toString.call(e)},isArray:Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},isFunction:function(e){return"[object Function]"===Object.prototype.toString.call(e)},isEmpty:function(e){if(null===e)return!0;if(r.isArray(e)||r.isString(e))return 0===e.length;for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},contains:function(e,t){return-1!==e.indexOf(t)},share:function(e,t){var n;if(!r.isArray(e)||!r.isArray(t))return!1;for(n=0;n<e.length;n++)if(r.contains(t,e[n]))return!0;return!1},clone:function(e){var t,n;if(!r.isObject(e))return null;t=r.isArray(e)?[]:{};for(n in e)r.isArray(e[n])?t[n]=r.clone(e[n]):r.isObject(e[n])?t[n]=r.extend({},e[n]):t[n]=e[n];return t},keys:function(e){return Object.keys(e)},extend:function(e){if(!r.isObject(e))return e;for(var t,n,i=1,s=arguments.length;s>i;i++){t=arguments[i];for(n in t)!r.isArray(arguments[i][n])&&r.isObject(arguments[i][n])?(void 0===e[n]&&(e[n]={}),r.extend(e[n],arguments[i][n])):hasOwnProperty.call(t,n)&&(r.isArray(t[n])?e[n]=r.clone(t[n]):e[n]=t[n])}return e},token:function(){return Math.random().toString(36).substr(2)}};var i={};i={_isValidEvent:function(e,t,n){return!(!e.hasOwnProperty(t)||"function"!=typeof n)},setEventListenerList:function(){return{insert:{listeners:[],listenersOnce:[]},update:{listeners:[],listenersOnce:[]},"delete":{listeners:[],listenersOnce:[]},change:{listeners:[],listenersOnce:[]}}},fire:function(e,t,n){var r;if(e[t]){for(r=0;r<e[t].listeners.length;r++)e[t].listeners[r](n);for(r=0;r<e[t].listenersOnce.length;r++)e[t].listenersOnce[r](n);e[t].listenersOnce.splice(0,e[t].listenersOnce.length)}},addEventListener:function(e,t,n){i._isValidEvent(e,t,n)&&e[t].listeners.push(n)},addOneTimeEventListener:function(e,t,n){i._isValidEvent(e,t,n)&&e[t].listenersOnce.push(n)},removeEventListener:function(e,t,n){var r;i._isValidEvent(e,t,n)&&(r=e[t].listeners.indexOf(n),r>=0&&e[t].listeners.splice(r,1))}},i.on=i.addEventListener,i.one=i.addOneTimeEventListener,i.off=i.removeEventListener;var s={};s={_isHavingNotOperator:function(e){var t,n,i,s,a,o,u,c=["$ne","$nin","$not"];if(i=[],r.contains(r.keys(e),"$or"))for(t=e.$or,o=0;o<t.length;o++)for(n in t[o])for(u=0;u<c.length;u++)s=new RegExp('"\\'+c[u]+'":'),a=JSON.stringify(t[o]).match(s),a&&i.push(n);else for(n in e)for(u=0;u<c.length;u++)s=new RegExp('"\\'+c[u]+'":'),a=JSON.stringify(e[n]).match(s),a&&i.push(n);return 0!==i.length?i:!1},_isHavingOrOperator:function(e){return e.$or&&r.isArray(e.$or)?e.$or:!1},_isHavingSpecialOperator:function(e){return{not:s._isHavingNotOperator(e),or:s._isHavingOrOperator(e)}},_isQueryOperator:function(e){var t,n=r.keys(e)[0];if(t=["$eq","$gt","$gte","$lt","$lte","$ne","$in","$nin","$exists","$or","$not"],!n||!n.match(/^\$/))return!1;if(r.contains(t,n))return n;throw new Error('The query operator "'+n+"\" isn't supported!")},_isMatchOp:function(e,t,n){switch(e){case!1:return t===n;case"$eq":return t===n.$eq;case"$gt":return t>n.$gt;case"$gte":return t>=n.$gte;case"$lt":return t<n.$lt;case"$lte":return t<=n.$lte;case"$ne":return t!==n.$ne;case"$in":return r.isArray(t)?r.share(n.$in,t):r.contains(n.$in,t);case"$nin":return r.isArray(t)?!r.share(n.$nin,t):!r.contains(n.$nin,t);case"$exists":return!!n.$exists;case"$not":return!s._isMatchOp(r.keys(n.$not)[0],t,n.$not);default:throw new Error("_query._isMatchOp: must never occur!")}},_isMatch:function(e,t,n){function i(e,t){var u,c;for(u in t){if(0===o&&(a=u),!e[u]){if(n.not&&r.contains(n.not,a)){if(n.or)return!0;continue}return!1}if(c=s._isQueryOperator(t[u]),r.isObject(t[u])&&!c)if(o+=1,n.or){if(i(e[u],t[u]))return!0}else{if(!i(e[u],t[u]))return!1;o-=1}else if(n.or){if(s._isMatchOp(c,e[u],t[u]))return!0}else if(!s._isMatchOp(c,e[u],t[u]))return!1}return!n.or}var a,o=0;return i(e,t)},isHavingSpecialOperator:function(e){return s._isHavingSpecialOperator(e)},isMatch:function(e,t,n){var r;if(!n.or)return s._isMatch(e,t,n);for(r=0;r<t.$or.length;r++)if(s._isMatch(e,t.$or[r],n))return!0;return!1}};var a={};a={_count:function(e,t,n,i){var a,o,u=s.isHavingSpecialOperator(t);if(!r.isObject(t)||r.isArray(t)||r.isFunction(t))return void(i&&i("query is not a valid object!",0));for(a=0,o=0;o<e.data.length;o++)s.isMatch(e.data[o],t,u)&&(a+=1);i&&i(null,a)},count:function(e,t,n,i){var s=e.db;i&&!r.isFunction(i)?i=void 0:i||r.isFunction(n)?!i&&r.isFunction(n)&&(i=n,n={}):i=void 0,!r.isArray(n)&&r.isObject(n)||(n={}),a._count(s,t,n,i)}};var o={};o={_delete:function(e,t,n,a,o){var u,c,f,l,p=s.isHavingSpecialOperator(n);if(!r.isObject(n)||r.isArray(n))return void(o&&o(null,null));if(r.isEmpty(n))return f=[],a.many?(u=e.data.length,f=r.clone(e.data),e.data.length=0):(u=1,f=e.data.splice(0,1)),i.fire(t,"change",f),i.fire(t,"delete",f),void(o&&o(null,u));for(u=0,f=[],c=e.data.length,l=0;c>l&&(!s.isMatch(e.data[l],n,p)||(f.push(e.data.splice(l,1)),u+=1,l--,c-=1,a.many));l++);i.fire(t,"change",f),i.fire(t,"delete",f),o&&o(null,u)},"delete":function(e,t,n,i,s){var a=e.db,u=e.eventQ;s&&!r.isFunction(s)?s=void 0:s||r.isFunction(i)?!s&&r.isFunction(i)&&(s=i,i={}):s=void 0,!r.isArray(i)&&r.isObject(i)||(i={}),i.many=t,o._delete(a,u,n,i,s)}};var u={};u={_initCursor:function(){return{query:{}}},_process:function(e,t){var n,i,a=e.cursor.query,o=e.db,u=s.isHavingSpecialOperator(a);if(r.isArray(a)||r.isFunction(a)||!r.isObject(a))return void t("This query isn't a valid Cursor query object");for(n=[],i=0;i<o.data.length;i++)s.isMatch(o.data[i],a,u)&&n.push(o.data[i]);t(null,n)},find:function(e,t){e.cursor||(e.cursor=u._initCursor()),e.cursor.query=t},toArray:function(e,t){r.isFunction(t)&&u._process(e,t)}};var c={};c={_schema:function(){return{data:[]}},_isNewId:function(e,t){var n,r=!0;for(n=0;n<e.data.length;n++)if(e.data[n]._id===t){r=!1;break}return r},_insert:function(e,t,n,s,a){var o,u,f,l;for(o=[],!r.isArray(n)&&r.isObject(n)?o.push(n):o=n,u=[],l=0;l<o.length;l++)if(r.isObject(o[l]))if(o[l]._id){if(c._isNewId(e,o[l]._id)&&(e.data.push(r.extend({},o[l])),u.push(r.extend({},o[l])),!s.many))break}else if(f=r.token(),e.data.push(r.extend({_id:f},o[l])),u.push(r.extend({_id:f},o[l])),!s.many)break;i.fire(t,"change",u),i.fire(t,"insert",u),a&&a(null,u)},insert:function(e,t,n,i,s){var a=e.db,o=e.eventQ;s&&!r.isFunction(s)?s=void 0:s||r.isFunction(i)?!s&&r.isFunction(i)&&(s=i,i={}):s=void 0,!r.isArray(i)&&r.isObject(i)||(i={}),i.many=t,(r.isArray(n)||r.isObject(n))&&c._insert(a,o,n,i,s)}};var f={};f={_push:function(e,t){var n,i,s,a,o;for(n in t)if(i=r.keys(t[n]),r.isArray(t[n])||!r.isObject(t[n])||r.contains(i,"$each")){if(hasOwnProperty.call(t,n)){if(e[n]||(e[n]=[]),"boolean"==typeof t[n]||"number"==typeof t[n]||"string"==typeof t[n]){e[n].push(t[n]);continue}if(r.isArray(t[n])){e[n].push(r.clone(t[n]));continue}if(r.isObject(t[n])&&r.isArray(t[n].$each)){for(s=t[n].$position,(void 0===s||"number"!=typeof s||0>s)&&(s=e[n].length),a=t[n].$slice,void 0!==a&&"number"==typeof s||(a=null),o=t[n].$each.length-1;o>=0;o--)e[n].splice(s,0,t[n].$each[o]);a>0?e[n].splice(a,e[n].length-a):0===a?e[n].length=0:0>a&&e[n].splice(0,e[n].length+a)}}}else e[n]||(e[n]={}),f._push(e[n],t[n]);return e},_apply:function(e,t,n){var i;for(i in t)if(!r.isArray(t[i])&&r.isObject(t[i])){if(!(e[i]||"$rename"!==n&&"$unset"!==n&&"$pop"!==n))break;e[i]||(e[i]={}),f._apply(e[i],t[i],n)}else if(hasOwnProperty.call(t,i))switch(n){case"$inc":"number"==typeof e[i]?e[i]+=t[i]:e[i]=t[i];break;case"$mul":"number"==typeof e[i]?e[i]*=t[i]:e[i]=0;break;case"$rename":e[i]&&(e[t[i]]=e[i],delete e[i]);break;case"$set":r.isArray(t[i])?e[i]=r.clone(t[i]):e[i]=t[i];break;case"$unset":e[i]&&delete e[i];break;case"$min":(!e[i]||"number"==typeof e[i]&&t[i]<e[i])&&(e[i]=t[i]);break;case"$max":(!e[i]||"number"==typeof e[i]&&t[i]>e[i])&&(e[i]=t[i]);break;case"$pop":r.isArray(e[i])&&(1===t[i]?e[i].pop():-1===t[i]&&e[i].shift());break;default:throw new Error('_update._apply: the operator "'+n+'" is unknown!')}return e},_replace:function(e,t){return e=r.extend({_id:e._id},t)},_applyTime:function(e,t){var n,i;for(n in t)i=r.keys(t[n])[0],r.isObject(t[n])&&"$type"!==i?(e[n]||(e[n]={}),f._applyTime(e[n],t[n])):hasOwnProperty.call(t,n)&&("timestamp"===t[n][i]?e[n]=Date.now():e[n]=(new Date).toISOString());return e},_updateThisDoc:function(e,t){var n=r.keys(t);if(!n[0].match(/^\$/))return f._replace(e,t);switch(n[0]){case"$inc":return f._apply(e,t.$inc,"$inc");case"$mul":return f._apply(e,t.$mul,"$mul");case"$rename":return f._apply(e,t.$rename,"$rename");case"$set":return f._apply(e,t.$set,"$set");case"$unset":return f._apply(e,t.$unset,"$unset");case"$min":return f._apply(e,t.$min,"$min");case"$max":return f._apply(e,t.$max,"$max");case"$currentDate":return f._applyTime(e,t.$currentDate);case"$pop":return f._apply(e,t.$pop,"$pop");case"$push":return f._push(e,t.$push,"$push");default:throw new Error('The Update Operator "'+n[0]+"\" isn't supported!")}},_update:function(e,t,n,a,o,u){var c,l,p,d=s.isHavingSpecialOperator(n);if(r.isArray(n)||r.isFunction(n)||!r.isObject(n))return void(u&&u("filter is not a valid object!"));if(r.isArray(a)||r.isFunction(a)||!r.isObject(a))return void(u&&u("update is not a valid object!"));for(l=[],p=0;p<e.data.length&&(!s.isMatch(e.data[p],n,d)||(c=f._updateThisDoc(e.data[p],a),l.push(r.extend({},c)),o.many));p++);i.fire(t,"change",l),i.fire(t,"update",l),u&&u(null,l)},update:function(e,t,n,i,s,a){var o=e.db,u=e.eventQ;a&&!r.isFunction(a)?a=void 0:a||r.isFunction(s)?!a&&r.isFunction(s)&&(a=s,s={}):a=void 0,!r.isArray(s)&&r.isObject(s)||(s={}),s.many=t,f._update(o,u,n,i,s,a)}};var l=function(e){e.db=c._schema(),e.eventQ=i.setEventListenerList()};return t.Create=function(){this.db;var e=function(e,t,n){!this.db||arguments.length<1||a.count(this,e,t,n)},t=function(e,t,n){!this.db||arguments.length<1||o["delete"](this,!0,e,t,n)},n=function(e,t,n){!this.db||arguments.length<1||o["delete"](this,!1,e,t,n)},r=function(e,t,n){this.db||l(this),arguments.length<1||c.insert(this,!0,e,t,n)},s=function(e,t,n){this.db||l(this),arguments.length<1||c.insert(this,!1,e,t,n)},p=function(e,t,n,r){!this.db||arguments.length<2||f.update(this,!0,e,t,n,r)},d=function(e,t,n,r){!this.db||arguments.length<2||f.update(this,!1,e,t,n,r)},h=function(e){return e=e||{},this.db?(u.find(this,e),this):this},y=function(e){this.db&&u.toArray(this,e)},v=function(e,t){this.db||l(this),i.addEventListener(this.eventQ,e,t)},$=function(e,t){this.db||l(this),i.addOneTimeEventListener(this.eventQ,e,t)},b=function(e,t){this.db||l(this),i.removeEventListener(this.eventQ,e,t)};return{count:e,deleteMany:t,deleteOne:n,insertMany:r,insertOne:s,updateMany:p,updateOne:d,find:h,toArray:y,addEventListener:v,addOneTimeEventListener:$,removeEventListener:b,on:v,one:$,off:b}},t});