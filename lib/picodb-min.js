/**
 * PicoDB v0.0.0
 *
 * @license
 * PicoDB is a tiny in-memory database that stores JSON documents.
 * Copyright (c) 2016 jclo <jclo@mobilabs.fr> (http://www.mobilabs.fr/).
 * Released under the MIT license. You may obtain a copy of the License
 * at: http://www.opensource.org/licenses/mit-license.php).
 */
!function(t,n){"use strict";"function"==typeof define&&define.amd?define([""],n):"object"==typeof exports?module.exports=n(t):t.PicoDB=n(t)}(this,function(t){"use strict";var n,e;e=t.PicoDB,n=function(){},n.noConflict=function(){return t.PicoDB=e,this},n.VERSION="0.0.0";var r={};r={isUndefined:function(t){return void 0===t},isNull:function(t){return null===t},isBoolean:function(t){return t===!0||t===!1||"[object Boolean]"===Object.prototype.toString.call(t)},isString:function(t){return"[object String]"===Object.prototype.toString.call(t)},isNumber:function(t){return"[object Number]"===Object.prototype.toString.call(t)},isNaN:function(t){return r.isNumber(t)&&t!==+t},isOdd:function(t){var n=t%2;return t===parseFloat(t)?!!n:void 0},isObject:function(t){var n=typeof t;return"function"===n||"object"===n&&!!t},isMath:function(t){return"[object Math]"===Object.prototype.toString.call(t)},isDate:function(t){return"[object Date]"===Object.prototype.toString.call(t)},isArray:Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},isFunction:function(t){return"[object Function]"===Object.prototype.toString.call(t)},isEmpty:function(t){if(null===t)return!0;if(r.isArray(t)||r.isString(t))return 0===t.length;for(var n in t)if(t.hasOwnProperty(n))return!1;return!0},contains:function(t,n){return-1!==t.indexOf(n)},share:function(t,n){var e;if(!r.isArray(t)||!r.isArray(n))return!1;for(e=0;e<t.length;e++)if(r.contains(n,t[e]))return!0;return!1},clone:function(t){var n,e;if(!r.isObject(t))return null;n=r.isArray(t)?[]:{};for(e in t)r.isObject(t[e])?n[e]=r.clone(t[e]):n[e]=t[e];return n},keys:function(t){return Object.keys(t)},extend:function(t){if(!r.isObject(t))return t;for(var n,e,i=1,s=arguments.length;s>i;i++){n=arguments[i];for(e in n)r.isObject(arguments[i][e])?(void 0===t[e]&&(t[e]={}),r.extend(t[e],arguments[i][e])):hasOwnProperty.call(n,e)&&(t[e]=n[e])}return t},token:function(){return Math.random().toString(36).substr(2)}};var i={};i={_isValidEvent:function(t,n,e){return!(!t.hasOwnProperty(n)||"function"!=typeof e)},setEventListenerList:function(){return{insert:{listeners:[],listenersOnce:[]},update:{listeners:[],listenersOnce:[]},"delete":{listeners:[],listenersOnce:[]},change:{listeners:[],listenersOnce:[]}}},fire:function(t,n,e){var r;if(t[n]){for(r=0;r<t[n].listeners.length;r++)t[n].listeners[r](e);for(r=0;r<t[n].listenersOnce.length;r++)t[n].listenersOnce[r](e);t[n].listenersOnce.splice(0,t[n].listenersOnce.length)}},addEventListener:function(t,n,e){i._isValidEvent(t,n,e)&&t[n].listeners.push(e)},addOneTimeEventListener:function(t,n,e){i._isValidEvent(t,n,e)&&t[n].listenersOnce.push(e)},removeEventListener:function(t,n,e){var r;i._isValidEvent(t,n,e)&&(r=t[n].listeners.indexOf(e),r>=0&&t[n].listeners.splice(r,1))}},i.on=i.addEventListener,i.one=i.addOneTimeEventListener,i.off=i.removeEventListener;var s={};s={_isHavingNotOperator:function(t){var n,e,i,s,o,a,u,c=["$ne","$nin","$not"];if(i=[],r.contains(r.keys(t),"$or"))for(n=t.$or,a=0;a<n.length;a++)for(e in n[a])for(u=0;u<c.length;u++)s=new RegExp('"\\'+c[u]+'":'),o=JSON.stringify(n[a]).match(s),o&&i.push(e);else for(e in t)for(u=0;u<c.length;u++)s=new RegExp('"\\'+c[u]+'":'),o=JSON.stringify(t[e]).match(s),o&&i.push(e);return 0!==i.length?i:!1},_isHavingOrOperator:function(t){return t.$or&&r.isArray(t.$or)?t.$or:!1},_isHavingSpecialOperator:function(t){return{not:s._isHavingNotOperator(t),or:s._isHavingOrOperator(t)}},_isQueryOperator:function(t){var n,e=r.keys(t)[0];if(n=["$eq","$gt","$gte","$lt","$lte","$ne","$in","$nin","$exists","$or","$not"],!e||!e.match(/^\$/))return!1;if(r.contains(n,e))return e;throw new Error('The query operator "'+e+"\" isn't supported!")},_isMatchOp:function(t,n,e){switch(t){case!1:return n===e;case"$eq":return n===e.$eq;case"$gt":return n>e.$gt;case"$gte":return n>=e.$gte;case"$lt":return n<e.$lt;case"$lte":return n<=e.$lte;case"$ne":return n!==e.$ne;case"$in":return r.isArray(n)?r.share(e.$in,n):r.contains(e.$in,n);case"$nin":return r.isArray(n)?!r.share(e.$nin,n):!r.contains(e.$nin,n);case"$exists":return!!e.$exists;case"$not":return!s._isMatchOp(r.keys(e.$not)[0],n,e.$not);default:throw new Error("_query._isMatchOp: must never occur!")}},_isMatch:function(t,n,e){function i(t,n){var u,c;for(u in n){if(0===a&&(o=u),!t[u]){if(e.not&&r.contains(e.not,o)){if(e.or)return!0;continue}return!1}if(c=s._isQueryOperator(n[u]),r.isObject(n[u])&&!c)if(a+=1,e.or){if(i(t[u],n[u]))return!0}else{if(!i(t[u],n[u]))return!1;a-=1}else if(e.or){if(s._isMatchOp(c,t[u],n[u]))return!0}else if(!s._isMatchOp(c,t[u],n[u]))return!1}return!e.or}var o,a=0;return i(t,n)},isHavingSpecialOperator:function(t){return s._isHavingSpecialOperator(t)},isMatch:function(t,n,e){var r;if(!e.or)return s._isMatch(t,n,e);for(r=0;r<n.$or.length;r++)if(s._isMatch(t,n.$or[r],e))return!0;return!1}};var o={};o={_count:function(t,n,e,i){var o,a,u=s.isHavingSpecialOperator(n);if(!r.isObject(n)||r.isArray(n)||r.isFunction(n))return void(i&&i("query is not a valid object!",0));for(o=0,a=0;a<t.data.length;a++)s.isMatch(t.data[a],n,u)&&(o+=1);i&&i(null,o)},count:function(t,n,e,i){var s=t.db;i&&!r.isFunction(i)?i=void 0:i||r.isFunction(e)?!i&&r.isFunction(e)&&(i=e,e={}):i=void 0,!r.isArray(e)&&r.isObject(e)||(e={}),o._count(s,n,e,i)}};var a={};a={_delete:function(t,n,e,o,a){var u,c,f,l,d=s.isHavingSpecialOperator(e);if(!r.isObject(e)||r.isArray(e))return void(a&&a(null,null));if(r.isEmpty(e))return f=[],o.many?(u=t.data.length,f=r.clone(t.data),t.data.length=0):(u=1,f=t.data.splice(0,1)),i.fire(n,"change",f),i.fire(n,"delete",f),void(a&&a(null,u));for(u=0,f=[],c=t.data.length,l=0;c>l&&(!s.isMatch(t.data[l],e,d)||(f.push(t.data.splice(l,1)),u+=1,l--,c-=1,o.many));l++);i.fire(n,"change",f),i.fire(n,"delete",f),a&&a(null,u)},"delete":function(t,n,e,i,s){var o=t.db,u=t.eventQ;s&&!r.isFunction(s)?s=void 0:s||r.isFunction(i)?!s&&r.isFunction(i)&&(s=i,i={}):s=void 0,!r.isArray(i)&&r.isObject(i)||(i={}),i.many=n,a._delete(o,u,e,i,s)}};var u={};u={_initCursor:function(){return{query:{}}},_process:function(t,n){var e,i,o=t.cursor.query,a=t.db,u=s.isHavingSpecialOperator(o);if(r.isArray(o)||r.isFunction(o)||!r.isObject(o))return void n("This query isn't a valid Cursor query object");for(e=[],i=0;i<a.data.length;i++)s.isMatch(a.data[i],o,u)&&e.push(a.data[i]);n(null,e)},find:function(t,n){t.cursor||(t.cursor=u._initCursor()),t.cursor.query=n},toArray:function(t,n){r.isFunction(n)&&u._process(t,n)}};var c={};c={_schema:function(){return{data:[]}},_isNewId:function(t,n){var e,r=!0;for(e=0;e<t.data.length;e++)if(t.data[e]._id===n){r=!1;break}return r},_insert:function(t,n,e,s,o){var a,u,f,l,d;for(a=[],!r.isArray(e)&&r.isObject(e)?a.push(e):a=e,u=[],d=0;d<a.length;d++)if(r.isObject(a[d]))if(a[d]._id){if(c._isNewId(t,a[d]._id)&&(t.data.push(a[d]),u.push(a[d]),!s.many))break}else{f={_id:r.token()};for(l in a[d])a[d].hasOwnProperty(l)&&(f[l]=a[d][l]);if(t.data.push(f),u.push(f),!s.many)break}i.fire(n,"change",u),i.fire(n,"insert",u),o&&o(null,u)},insert:function(t,n,e,i,s){var o=t.db,a=t.eventQ;s&&!r.isFunction(s)?s=void 0:s||r.isFunction(i)?!s&&r.isFunction(i)&&(s=i,i={}):s=void 0,!r.isArray(i)&&r.isObject(i)||(i={}),i.many=n,(r.isArray(e)||r.isObject(e))&&c._insert(o,a,e,i,s)}};var f={};f={_set:function(t,n){var e;for(e in n)n.hasOwnProperty(e)&&"_id"!==e&&(t[e]=n[e]);return t},_unset:function(t,n){var e;for(e in n)n.hasOwnProperty(e)&&"_id"!==e&&delete t[e];return t},_replace:function(t,n){var e;for(e in t)"_id"!==e&&delete t[e];for(e in n)n.hasOwnProperty(e)&&"_id"!==e&&(t[e]=n[e]);return t},_updateThisDoc:function(t,n){var e=r.keys(n);return"$set"===e[0]?f._set(t,n.$set):"$unset"===e[0]?f._unset(t,n.$unset):f._replace(t,n)},_update:function(t,n,e,o,a,u){var c,l,d=s.isHavingSpecialOperator(e);if(r.isArray(e)||r.isFunction(e)||!r.isObject(e))return void(u&&u("filter is not a valid object!"));if(r.isArray(o)||r.isFunction(o)||!r.isObject(o))return void(u&&u("update is not a valid object!"));for(c=[],l=0;l<t.data.length&&(!s.isMatch(t.data[l],e,d)||(c.push(f._updateThisDoc(t.data[l],o)),a.many));l++);i.fire(n,"change",c),i.fire(n,"update",c),u&&u(null,c)},update:function(t,n,e,i,s,o){var a=t.db,u=t.eventQ;o&&!r.isFunction(o)?o=void 0:o||r.isFunction(s)?!o&&r.isFunction(s)&&(o=s,s={}):o=void 0,!r.isArray(s)&&r.isObject(s)||(s={}),s.many=n,f._update(a,u,e,i,s,o)}};var l=function(t){t.db=c._schema(),t.eventQ=i.setEventListenerList()};return n.Create=function(){this.db;var t=function(t,n,e){!this.db||arguments.length<1||o.count(this,t,n,e)},n=function(t,n,e){!this.db||arguments.length<1||a["delete"](this,!0,t,n,e)},e=function(t,n,e){!this.db||arguments.length<1||a["delete"](this,!1,t,n,e)},r=function(t,n,e){this.db||l(this),arguments.length<1||c.insert(this,!0,t,n,e)},s=function(t,n,e){this.db||l(this),arguments.length<1||c.insert(this,!1,t,n,e)},d=function(t,n,e,r){!this.db||arguments.length<2||f.update(this,!0,t,n,e,r)},h=function(t,n,e,r){!this.db||arguments.length<2||f.update(this,!1,t,n,e,r)},v=function(t){return t=t||{},this.db?(u.find(this,t),this):this},p=function(t){this.db&&u.toArray(this,t)},O=function(t,n){this.db||l(this),i.addEventListener(this.eventQ,t,n)},y=function(t,n){this.db||l(this),i.addOneTimeEventListener(this.eventQ,t,n)},b=function(t,n){this.db||l(this),i.removeEventListener(this.eventQ,t,n)};return{count:t,deleteMany:n,deleteOne:e,insertMany:r,insertOne:s,updateMany:d,updateOne:h,find:v,toArray:p,addEventListener:O,addOneTimeEventListener:y,removeEventListener:b,on:O,one:y,off:b}},n});