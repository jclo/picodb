/**
 * PicoDB v0.5.0
 *
 * @license
 * PicoDB is a tiny in-memory database that stores JSON documents.
 * Copyright (c) 2016 jclo <jclo@mobilabs.fr> (http://www.mobilabs.fr/).
 * Released under the MIT license. You may obtain a copy of the License
 * at: http://www.opensource.org/licenses/mit-license.php).
 */
!function(e,n){"use strict";"function"==typeof define&&define.amd?define([""],n):"object"==typeof exports?module.exports=n(e):e.PicoDB=n(e)}(this,function(e){"use strict";var n,t;t=e.PicoDB,n=function(){},n.noConflict=function(){return e.PicoDB=t,this},n.VERSION="0.5.0";var r={};r={isUndefined:function(e){return void 0===e},isNull:function(e){return null===e},isBoolean:function(e){return e===!0||e===!1||"[object Boolean]"===Object.prototype.toString.call(e)},isString:function(e){return"[object String]"===Object.prototype.toString.call(e)},isNumber:function(e){return"[object Number]"===Object.prototype.toString.call(e)},isNaN:function(e){return r.isNumber(e)&&e!==+e},isOdd:function(e){var n=e%2;return e===parseFloat(e)?!!n:void 0},isObject:function(e){var n=typeof e;return"function"===n||"object"===n&&!!e},isMath:function(e){return"[object Math]"===Object.prototype.toString.call(e)},isDate:function(e){return"[object Date]"===Object.prototype.toString.call(e)},isArray:Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},isFunction:function(e){return"[object Function]"===Object.prototype.toString.call(e)},isEmpty:function(e){if(null===e)return!0;if(r.isArray(e)||r.isString(e))return 0===e.length;for(var n in e)if(e.hasOwnProperty(n))return!1;return!0},contains:function(e,n){return-1!==e.indexOf(n)},share:function(e,n){var t;if(!r.isArray(e)||!r.isArray(n))return!1;for(t=0;t<e.length;t++)if(r.contains(n,e[t]))return!0;return!1},clone:function(e){var n,t;if(!r.isObject(e))return null;n=r.isArray(e)?[]:{};for(t in e)r.isArray(e[t])?n[t]=r.clone(e[t]):r.isObject(e[t])?n[t]=r.extend({},e[t]):n[t]=e[t];return n},keys:function(e){return Object.keys(e)},extend:function(e){if(!r.isObject(e))return e;for(var n,t,i=1,s=arguments.length;s>i;i++){n=arguments[i];for(t in n)!r.isArray(arguments[i][t])&&r.isObject(arguments[i][t])?(void 0===e[t]&&(e[t]={}),r.extend(e[t],arguments[i][t])):hasOwnProperty.call(n,t)&&(r.isArray(n[t])?e[t]=r.clone(n[t]):e[t]=n[t])}return e},token:function(){return Math.random().toString(36).substr(2)}};var i={};i={_isValidEvent:function(e,n,t){return!(!e.hasOwnProperty(n)||"function"!=typeof t)},setEventListenerList:function(){return{insert:{listeners:[],listenersOnce:[]},update:{listeners:[],listenersOnce:[]},"delete":{listeners:[],listenersOnce:[]},change:{listeners:[],listenersOnce:[]}}},fire:function(e,n,t){var r;if(e[n]){for(r=0;r<e[n].listeners.length;r++)e[n].listeners[r](t);for(r=0;r<e[n].listenersOnce.length;r++)e[n].listenersOnce[r](t);e[n].listenersOnce.splice(0,e[n].listenersOnce.length)}},addEventListener:function(e,n,t){i._isValidEvent(e,n,t)&&e[n].listeners.push(t)},addOneTimeEventListener:function(e,n,t){i._isValidEvent(e,n,t)&&e[n].listenersOnce.push(t)},removeEventListener:function(e,n,t){var r;i._isValidEvent(e,n,t)&&(r=e[n].listeners.indexOf(t),r>=0&&e[n].listeners.splice(r,1))}},i.on=i.addEventListener,i.one=i.addOneTimeEventListener,i.off=i.removeEventListener;var s={};s={_isHavingNotOperator:function(e){var n,t,i,s,a,o,u,c=["$ne","$nin","$not"];if(i=[],r.contains(r.keys(e),"$or"))for(n=e.$or,o=0;o<n.length;o++)for(t in n[o])for(u=0;u<c.length;u++)s=new RegExp('"\\'+c[u]+'":'),a=JSON.stringify(n[o]).match(s),a&&i.push(t);else for(t in e)for(u=0;u<c.length;u++)s=new RegExp('"\\'+c[u]+'":'),a=JSON.stringify(e[t]).match(s),a&&i.push(t);return 0!==i.length?i:!1},_isHavingOrOperator:function(e){return e.$or&&r.isArray(e.$or)?e.$or:!1},_isHavingSpecialOperator:function(e){return{not:s._isHavingNotOperator(e),or:s._isHavingOrOperator(e)}},_isConditionTrue:function(e,n,t){switch(t){case"$eq":return e===n;case"$gt":return e>n;case"$gte":return e>=n;case"$lt":return n>e;case"$lte":return n>=e;case"$ne":return e!==n;case"$in":return r.isArray(e)?r.share(n,e):r.contains(n,e);case"$nin":return r.isArray(e)?!r.share(n,e):!r.contains(n,e);case"$not":return!s._areConditionsTrue(e,n);case"$exists":return!!n;case"geoWithin":return!0;default:throw new Error("_query._isConditionTrue: this must never occur!")}},_areConditionsTrue:function(e,n){var t;if(!r.isArray(n)&&!r.isObject(n))return e===n;for(t in n)if(!s._isConditionTrue(e,n[t],t))return!1;return!0},_query:function(e,n,t){function i(e,n){var u;for(u in n){if(0===o&&(a=u),!e[u]){if(t.not&&r.contains(t.not,a)){if(t.or)return!0;continue}return!1}if(r.isObject(n[u])&&!r.keys(n[u])[0].match(/^\$/)){if(o+=1,i(e[u],n[u])){if(t.or)return!0}else if(o-=1,!t.or)return!1}else if(s._areConditionsTrue(e[u],n[u])){if(t.or)return!0}else if(!t.or)return!1}return!t.or}var a,o=0;return i(e,n)},isHavingSpecialOperator:function(e){return s._isHavingSpecialOperator(e)},isMatch:function(e,n,t){var r;if(!t.or)return s._query(e,n,t);for(r=0;r<n.$or.length;r++)if(s._query(e,n.$or[r],t))return!0;return!1}};var a={};a={_count:function(e,n,t,i){var a,o,u=s.isHavingSpecialOperator(n);if(!r.isObject(n)||r.isArray(n)||r.isFunction(n))return void(i&&i("query is not a valid object!",0));for(a=0,o=0;o<e.data.length;o++)s.isMatch(e.data[o],n,u)&&(a+=1);i&&i(null,a)},count:function(e,n,t,i){var s=e.db;i&&!r.isFunction(i)?i=void 0:i||r.isFunction(t)?!i&&r.isFunction(t)&&(i=t,t={}):i=void 0,!r.isArray(t)&&r.isObject(t)||(t={}),a._count(s,n,t,i)}};var o={};o={_delete:function(e,n,t,a,o){var u,c,l,f,p=s.isHavingSpecialOperator(t);if(!r.isObject(t)||r.isArray(t))return void(o&&o(null,null));if(r.isEmpty(t))return l=[],a.many?(u=e.data.length,l=r.clone(e.data),e.data.length=0):(u=1,l=e.data.splice(0,1)),i.fire(n,"change",l),i.fire(n,"delete",l),void(o&&o(null,u));for(u=0,l=[],c=e.data.length,f=0;c>f&&(!s.isMatch(e.data[f],t,p)||(l.push(e.data.splice(f,1)),u+=1,f--,c-=1,a.many));f++);i.fire(n,"change",l),i.fire(n,"delete",l),o&&o(null,u)},"delete":function(e,n,t,i,s){var a=e.db,u=e.eventQ;s&&!r.isFunction(s)?s=void 0:s||r.isFunction(i)?!s&&r.isFunction(i)&&(s=i,i={}):s=void 0,!r.isArray(i)&&r.isObject(i)||(i={}),i.many=n,o._delete(a,u,t,i,s)}};var u={};u={_initCursor:function(){return{query:{}}},_process:function(e,n){var t,i,a=e.cursor.query,o=e.db,u=s.isHavingSpecialOperator(a);if(r.isArray(a)||r.isFunction(a)||!r.isObject(a))return void n("This query isn't a valid Cursor query object");for(t=[],i=0;i<o.data.length;i++)s.isMatch(o.data[i],a,u)&&t.push(o.data[i]);n(null,t)},find:function(e,n){e.cursor||(e.cursor=u._initCursor()),e.cursor.query=n},toArray:function(e,n){r.isFunction(n)&&u._process(e,n)}};var c={};c={_schema:function(){return{data:[]}},_isNewId:function(e,n){var t,r=!0;for(t=0;t<e.data.length;t++)if(e.data[t]._id===n){r=!1;break}return r},_insert:function(e,n,t,s,a){var o,u,l,f;for(o=[],!r.isArray(t)&&r.isObject(t)?o.push(t):o=t,u=[],f=0;f<o.length;f++)if(r.isObject(o[f]))if(o[f]._id){if(c._isNewId(e,o[f]._id)&&(e.data.push(r.extend({},o[f])),u.push(r.extend({},o[f])),!s.many))break}else if(l=r.token(),e.data.push(r.extend({_id:l},o[f])),u.push(r.extend({_id:l},o[f])),!s.many)break;i.fire(n,"change",u),i.fire(n,"insert",u),a&&a(null,u)},insert:function(e,n,t,i,s){var a=e.db,o=e.eventQ;s&&!r.isFunction(s)?s=void 0:s||r.isFunction(i)?!s&&r.isFunction(i)&&(s=i,i={}):s=void 0,!r.isArray(i)&&r.isObject(i)||(i={}),i.many=n,(r.isArray(t)||r.isObject(t))&&c._insert(a,o,t,i,s)}};var l={};l={_pull:function(e,n){var t,i,s,a,o,u,c;for(t in n)if(r.isObject(n[t])&&!r.isArray(e[t])){if(!e[t])continue;l._pull(e[t],n[t])}else if(hasOwnProperty.call(n,t)){if(!e[t]||!r.isArray(e[t]))continue;if("boolean"==typeof n[t]||"number"==typeof n[t]||"string"==typeof n[t]){a=e[t].indexOf(n[t]),a>-1&&e[t].splice(a,1);continue}if(r.isObject(n[t])&&!r.keys(n[t])[0].match(/^\$/)){for(c=e[t].length-1;c>=0&&r.isObject(e[t][c]);c--){s=!0;for(i in n[t])if(e[t][c][i]!==n[t][i]){s=!1;break}s&&e[t].splice(c,1)}continue}if(r.isObject(n[t])){switch(o=r.keys(n[t])[0]){case"$eq":a=e[t].indexOf(n[t].$eq),a>-1&&e[t].splice(a,1);break;case"$gt":for(c=e[t].length-1;c>=0;c--)e[t][c]>n[t].$gt&&e[t].splice(c,1);break;case"$gte":for(c=e[t].length-1;c>=0;c--)e[t][c]>=n[t].$gte&&e[t].splice(c,1);break;case"$lt":for(c=e[t].length-1;c>=0;c--)e[t][c]<n[t].$lt&&e[t].splice(c,1);break;case"$lte":for(c=e[t].length-1;c>=0;c--)e[t][c]<=n[t].$lte&&e[t].splice(c,1);break;case"$ne":for(c=e[t].length-1;c>=0;c--)e[t][c]!==n[t].$ne&&e[t].splice(c,1);break;case"$in":if(!r.isArray(n[t].$in))break;for(c=0;c<n[t].$in.length;c++)a=e[t].indexOf(n[t].$in[c]),a>-1&&e[t].splice(a,1);break;case"$nin":if(!r.isArray(n[t].$nin))break;for(u=[],c=0;c<n[t].$nin.length;c++)a=e[t].indexOf(n[t].$nin[c]),a>-1&&u.push(n[t].$nin[c]);e[t]=r.clone(u);break;default:throw new Error('_update._pull: the operator "'+o+'" is not supported!')}continue}}return e},_push:function(e,n){var t,i,s,a,o;for(t in n)if(i=r.keys(n[t]),r.isArray(n[t])||!r.isObject(n[t])||i[0].match(/^\$/)){if(hasOwnProperty.call(n,t)){if(e[t]||(e[t]=[]),"boolean"==typeof n[t]||"number"==typeof n[t]||"string"==typeof n[t]){e[t].push(n[t]);continue}if(r.isArray(n[t])){e[t].push(r.clone(n[t]));continue}if(r.isObject(n[t])&&r.isArray(n[t].$each)){for(s=n[t].$position,(void 0===s||"number"!=typeof s||0>s)&&(s=e[t].length),a=n[t].$slice,void 0!==a&&"number"==typeof s||(a=null),o=n[t].$each.length-1;o>=0;o--)e[t].splice(s,0,n[t].$each[o]);a>0?e[t].splice(a,e[t].length-a):0===a?e[t].length=0:0>a&&e[t].splice(0,e[t].length+a)}}}else e[t]||(e[t]={}),l._push(e[t],n[t]);return e},_apply:function(e,n,t){var i,s,a;for(i in n)if(!r.isArray(n[i])&&r.isObject(n[i])){if(!(e[i]||"$rename"!==t&&"$unset"!==t&&"$pop"!==t))break;e[i]||(e[i]={}),l._apply(e[i],n[i],t)}else if(hasOwnProperty.call(n,i))switch(t){case"$inc":"number"==typeof e[i]?e[i]+=n[i]:e[i]=n[i];break;case"$mul":"number"==typeof e[i]?e[i]*=n[i]:e[i]=0;break;case"$rename":e[i]&&(e[n[i]]=e[i],delete e[i]);break;case"$set":r.isArray(n[i])?e[i]=r.clone(n[i]):e[i]=n[i];break;case"$unset":e[i]&&delete e[i];break;case"$min":(!e[i]||"number"==typeof e[i]&&n[i]<e[i])&&(e[i]=n[i]);break;case"$max":(!e[i]||"number"==typeof e[i]&&n[i]>e[i])&&(e[i]=n[i]);break;case"$pop":r.isArray(e[i])&&(1===n[i]?e[i].pop():-1===n[i]&&e[i].shift());break;case"$pullAll":if(r.isArray(e[i])&&r.isArray(n[i]))for(s=0;s<n[i].length;s++)for(a=e[i].length-1;a>=0;a--)e[i][a]===n[i][s]&&e[i].splice(a,1);break;default:throw new Error('_update._apply: the operator "'+t+'" is unknown!')}return e},_replace:function(e,n){return e=r.extend({_id:e._id},n)},_applyTime:function(e,n){var t,i;for(t in n)i=r.keys(n[t])[0],r.isObject(n[t])&&"$type"!==i?(e[t]||(e[t]={}),l._applyTime(e[t],n[t])):hasOwnProperty.call(n,t)&&("timestamp"===n[t][i]?e[t]=Date.now():e[t]=(new Date).toISOString());return e},_updateThisDoc:function(e,n){var t=r.keys(n);if(!t[0].match(/^\$/))return l._replace(e,n);switch(t[0]){case"$inc":return l._apply(e,n.$inc,"$inc");case"$mul":return l._apply(e,n.$mul,"$mul");case"$rename":return l._apply(e,n.$rename,"$rename");case"$set":return l._apply(e,n.$set,"$set");case"$unset":return l._apply(e,n.$unset,"$unset");case"$min":return l._apply(e,n.$min,"$min");case"$max":return l._apply(e,n.$max,"$max");case"$currentDate":return l._applyTime(e,n.$currentDate);case"$pop":return l._apply(e,n.$pop,"$pop");case"$pullAll":return l._apply(e,n.$pullAll,"$pullAll");case"$pull":return l._pull(e,n.$pull,"$pull");case"$push":return l._push(e,n.$push,"$push");default:throw new Error('The Update Operator "'+t[0]+"\" isn't supported!")}},_update:function(e,n,t,a,o,u){var c,f,p,d=s.isHavingSpecialOperator(t);if(r.isArray(t)||r.isFunction(t)||!r.isObject(t))return void(u&&u("filter is not a valid object!"));if(r.isArray(a)||r.isFunction(a)||!r.isObject(a))return void(u&&u("update is not a valid object!"));for(f=[],p=0;p<e.data.length&&(!s.isMatch(e.data[p],t,d)||(c=l._updateThisDoc(e.data[p],a),f.push(r.extend({},c)),o.many));p++);i.fire(n,"change",f),i.fire(n,"update",f),u&&u(null,f)},update:function(e,n,t,i,s,a){var o=e.db,u=e.eventQ;a&&!r.isFunction(a)?a=void 0:a||r.isFunction(s)?!a&&r.isFunction(s)&&(a=s,s={}):a=void 0,!r.isArray(s)&&r.isObject(s)||(s={}),s.many=n,l._update(o,u,t,i,s,a)}};var f=function(e){e.db=c._schema(),e.eventQ=i.setEventListenerList()};return n.Create=function(){this.db;var e=function(e,n,t){!this.db||arguments.length<1||a.count(this,e,n,t)},n=function(e,n,t){!this.db||arguments.length<1||o["delete"](this,!0,e,n,t)},t=function(e,n,t){!this.db||arguments.length<1||o["delete"](this,!1,e,n,t)},r=function(e,n,t){this.db||f(this),arguments.length<1||c.insert(this,!0,e,n,t)},s=function(e,n,t){this.db||f(this),arguments.length<1||c.insert(this,!1,e,n,t)},p=function(e,n,t,r){!this.db||arguments.length<2||l.update(this,!0,e,n,t,r)},d=function(e,n,t,r){!this.db||arguments.length<2||l.update(this,!1,e,n,t,r)},h=function(e){return e=e||{},this.db?(u.find(this,e),this):this},y=function(e){this.db&&u.toArray(this,e)},b=function(e,n){this.db||f(this),i.addEventListener(this.eventQ,e,n)},v=function(e,n){this.db||f(this),i.addOneTimeEventListener(this.eventQ,e,n)},$=function(e,n){this.db||f(this),i.removeEventListener(this.eventQ,e,n)};return{count:e,deleteMany:n,deleteOne:t,insertMany:r,insertOne:s,updateMany:p,updateOne:d,find:h,toArray:y,addEventListener:b,addOneTimeEventListener:v,removeEventListener:$,on:b,one:v,off:$}},n});