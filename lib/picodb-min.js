/**
 * PicoDB v0.6.0alpha1
 *
 * @license
 * PicoDB is a tiny in-memory database that stores JSON documents.
 * Copyright (c) 2016 jclo <jclo@mobilabs.fr> (http://www.mobilabs.fr/).
 * Released under the MIT license. You may obtain a copy of the License
 * at: http://www.opensource.org/licenses/mit-license.php).
 */
!function(e,n){"use strict";"function"==typeof define&&define.amd?define([""],n):"object"==typeof exports?module.exports=n(e):e.PicoDB=n(e)}(this,function(e){"use strict";var n,t;t=e.PicoDB,n=function(){},n.noConflict=function(){return e.PicoDB=t,this},n.VERSION="0.6.0alpha1";var r={};r={isUndefined:function(e){return void 0===e},isNull:function(e){return null===e},isBoolean:function(e){return e===!0||e===!1||"[object Boolean]"===Object.prototype.toString.call(e)},isString:function(e){return"[object String]"===Object.prototype.toString.call(e)},isNumber:function(e){return"[object Number]"===Object.prototype.toString.call(e)},isNaN:function(e){return r.isNumber(e)&&e!==+e},isOdd:function(e){var n=e%2;return e===parseFloat(e)?!!n:void 0},isObject:function(e){var n=typeof e;return"function"===n||"object"===n&&!!e},isMath:function(e){return"[object Math]"===Object.prototype.toString.call(e)},isDate:function(e){return"[object Date]"===Object.prototype.toString.call(e)},isArray:Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},isFunction:function(e){return"[object Function]"===Object.prototype.toString.call(e)},isEmpty:function(e){if(null===e)return!0;if(r.isArray(e)||r.isString(e))return 0===e.length;for(var n in e)if(e.hasOwnProperty(n))return!1;return!0},contains:function(e,n){return-1!==e.indexOf(n)},share:function(e,n){var t;if(!r.isArray(e)||!r.isArray(n))return!1;for(t=0;t<e.length;t++)if(r.contains(n,e[t]))return!0;return!1},clone:function(e){var n,t;if(!r.isObject(e))return null;n=r.isArray(e)?[]:{};for(t in e)r.isArray(e[t])?n[t]=r.clone(e[t]):r.isObject(e[t])?n[t]=r.extend({},e[t]):n[t]=e[t];return n},keys:function(e){return Object.keys(e)},extend:function(e){if(!r.isObject(e))return e;for(var n,t,i=1,o=arguments.length;o>i;i++){n=arguments[i];for(t in n)!r.isArray(arguments[i][t])&&r.isObject(arguments[i][t])?(void 0===e[t]&&(e[t]={}),r.extend(e[t],arguments[i][t])):hasOwnProperty.call(n,t)&&(r.isArray(n[t])?e[t]=r.clone(n[t]):e[t]=n[t])}return e},token:function(){return Math.random().toString(36).substr(2)}};var i={};i={_isValidEvent:function(e,n,t){return!(!e.hasOwnProperty(n)||"function"!=typeof t)},setEventListenerList:function(){return{insert:{listeners:[],listenersOnce:[]},update:{listeners:[],listenersOnce:[]},"delete":{listeners:[],listenersOnce:[]},change:{listeners:[],listenersOnce:[]}}},fire:function(e,n,t){var r;if(e[n]){for(r=0;r<e[n].listeners.length;r++)e[n].listeners[r](t);for(r=0;r<e[n].listenersOnce.length;r++)e[n].listenersOnce[r](t);e[n].listenersOnce.splice(0,e[n].listenersOnce.length)}},addEventListener:function(e,n,t){i._isValidEvent(e,n,t)&&e[n].listeners.push(t)},addOneTimeEventListener:function(e,n,t){i._isValidEvent(e,n,t)&&e[n].listenersOnce.push(t)},removeEventListener:function(e,n,t){var r;i._isValidEvent(e,n,t)&&(r=e[n].listeners.indexOf(t),r>=0&&e[n].listeners.splice(r,1))}},i.on=i.addEventListener,i.one=i.addOneTimeEventListener,i.off=i.removeEventListener;var o={};o={_isPointInPolygon2:function(e,n){var t,r,i,o,s;for(s=0;s<n.length;s++)if(e[0]===n[s][0]&&e[1]===n[s][1])return"vertex";for(t=0,s=1;s<n.length;s++){if(r=n[s-1],i=n[s],r[1]===i[1]&&r[1]===e[1]&&e[0]>Math.min(r[0],i[0])&&e[0]<Math.max(r[0],i[0]))return"boundary";if(e[1]>Math.min(r[1],i[1])&&e[1]<=Math.max(r[1],i[1])&&e[0]<=Math.max(r[0],i[0])&&r[1]!==i[1]){if(o=(e[1]-r[1])*(i[0]-r[0])/(i[1]-r[1])+r[0],o===e[0])return"boundary";(r[0]===i[0]||e[0]<=o)&&(t+=1)}}return t%2!==0?"inside":"outside"},_isPointInPolygon:function(e,n){var t,r,i=0;for(r=0;r<n.length-1;r++)(n[r][1]<=e[1]&&n[r+1][1]>e[1]||n[r][1]>e[1]&&n[r+1][1]<=e[1])&&(t=(e[1]-n[r][1])/(n[r+1][1]-n[r][1]),e[0]<n[r][0]+t*(n[r+1][0]-n[r][0])&&i++);return i%2!==0},_isPointInPolygonOrMultipolygon:function(e,n){var t,r;switch(n.type){case"Multipolygon":for(t=0;t<n.coordinates.length;t++)for(r=0;r<n.coordinates[t].length;r++)if(o._isPointInPolygon(e.coordinates,n.coordinates[t][r]))return!0;return!1;case"Polygon":for(t=0;t<n.coordinates.length;t++)if(o._isPointInPolygon(e.coordinates,n.coordinates[t]))return!0;return!1;default:throw new Error('_geo._within: the GeoSpatial $geoWihin operator with a $geometry.type"'+n.type+'" is unknown!')}},_box:function(e,n){var t,r;return t=[[[n[0][0],n[0][1]],[n[1][0],n[0][1]],[n[1][0],n[1][1]],[n[0][0],n[1][1]]]],r={type:"Polygon",coordinates:t},o._isPointInPolygonOrMultipolygon(e,r)},_polygon:function(e,n){var t;return t={type:"Polygon",coordinates:[n,[n[0][0],n[0][1]]]},o._isPointInPolygonOrMultipolygon(e,t)},_center:function(e,n){var t;return t=Math.sqrt(Math.pow(n[0][0]-e.coordinates[0],2)+Math.pow(n[0][1]-e.coordinates[1],2)),t<n[1]},_centerSphere:function(e,n){var t;return t=Math.sqrt(Math.pow(n[0][0]-e.coordinates[0],2)+Math.pow(n[0][1]-e.coordinates[1],2)),t<n[1]/Math.PI*180},_within:function(e,n){switch(e.type){case"Point":return o._isPointInPolygonOrMultipolygon(e,n);case"LineString":return!1;case"Polygon":return!1;case"MultiPoint":return!1;case"MultiLineString":return!1;case"MultiPolygon":return!1;case"GeometryCollection":return!1;default:return!1}},_geoWithin:function(e,n){var t=r.keys(n)[0];if(!r.isObject(n))return!1;switch(t){case"$geometry":return o._within(e,n.$geometry);case"$box":return o._box(e,n.$box);case"$polygon":return o._polygon(e,n.$polygon);case"$center":return o._center(e,n.$center);case"$centerSphere":return o._centerSphere(e,n.$centerSphere);default:throw new Error('_geo._geoWithin: the GeoSpatial $geoWihin operator "'+t+'" is unknown!')}},_interLineString:function(e,n){var t,r,i,s,a;for(s=0;s<e.coordinates.length;s++){for(a=0;a<n.coordinates.length;a++)if(i=!1,o._isPointInPolygon(e.coordinates[s],n.coordinates[a])){if(t=!0,i=!0,t&&r)return!0;break}if(!i&&(r=!0,t&&r))return!0}return!1},_interPolygon:function(e,n){var t,r,i,s,a,u;for(s=0;s<e.coordinates.length;s++)for(a=0;a<e.coordinates[s].length;a++){for(u=0;u<n.coordinates.length;u++)if(i=!1,o._isPointInPolygon(e.coordinates[s][a],n.coordinates[u])){if(t=!0,i=!0,t&&r)return!0;break}if(!i&&(r=!0,t&&r))return!0}return!1},_intersects:function(e,n){switch(e.type){case"Point":return!1;case"LineString":return o._interLineString(e,n);case"Polygon":return o._interPolygon(e,n);case"MultiPoint":return!1;case"MultiLineString":return!1;case"MultiPolygon":return!1;case"GeometryCollection":return!1;default:return!1}},_geoIntersects:function(e,n){if(!n.hasOwnProperty("$geometry"))return!1;switch(n.$geometry.type){case"Polygon":return o._intersects(e,n.$geometry);default:throw new Error('_geo._geoIntersects: the GeoSpatial $geoIntersects type "'+n.$geometry.type+'" is not supported!')}},_query:function(e,n){var t;for(t in n)switch(t){case"$geoWithin":return o._geoWithin(e,n[t]);case"$geoIntersects":return o._geoIntersects(e,n[t]);case"$near":return!1;case"$nearSphere":return!1;default:throw new Error('_geo._query: the Geo Operator "'+t+'" is unknown!')}},query:function(e,n){return o._query(e,n)}};var s={};s={_isHavingNotOperator:function(e){var n,t,i,o,s,a,u,c=["$ne","$nin","$not"];if(i=[],r.contains(r.keys(e),"$or"))for(n=e.$or,a=0;a<n.length;a++)for(t in n[a])for(u=0;u<c.length;u++)o=new RegExp('"\\'+c[u]+'":'),s=JSON.stringify(n[a]).match(o),s&&i.push(t);else for(t in e)for(u=0;u<c.length;u++)o=new RegExp('"\\'+c[u]+'":'),s=JSON.stringify(e[t]).match(o),s&&i.push(t);return 0!==i.length?i:!1},_isHavingOrOperator:function(e){return e.$or&&r.isArray(e.$or)?e.$or:!1},_isHavingSpecialOperator:function(e){return{not:s._isHavingNotOperator(e),or:s._isHavingOrOperator(e)}},_isConditionTrue:function(e,n,t){switch(t){case"$eq":return e===n;case"$gt":return e>n;case"$gte":return e>=n;case"$lt":return n>e;case"$lte":return n>=e;case"$ne":return e!==n;case"$in":return r.isArray(e)?r.share(n,e):r.contains(n,e);case"$nin":return r.isArray(e)?!r.share(n,e):!r.contains(n,e);case"$not":return!s._areConditionsTrue(e,n);case"$exists":return!!n;case"$geoWithin":return o.query(e,{$geoWithin:n});case"$geoIntersects":return o.query(e,{$geoIntersects:n});case"$near":return o.query(e,{$near:n});case"$nearSphere":return o.query(e,{$nearSphere:n});default:throw new Error('_query._isConditionTrue: the operator "'+t+'" is unknown!')}},_areConditionsTrue:function(e,n){var t;if(!r.isArray(n)&&!r.isObject(n))return e===n;for(t in n)if(!s._isConditionTrue(e,n[t],t))return!1;return!0},_query:function(e,n,t){function i(e,n){var u;for(u in n){if(0===a&&(o=u),!e[u]){if(t.not&&r.contains(t.not,o)){if(t.or)return!0;continue}return!1}if(r.isObject(n[u])&&!r.keys(n[u])[0].match(/^\$/)){if(a+=1,i(e[u],n[u])){if(t.or)return!0}else if(a-=1,!t.or)return!1}else if(s._areConditionsTrue(e[u],n[u])){if(t.or)return!0}else if(!t.or)return!1}return!t.or}var o,a=0;return i(e,n)},isHavingSpecialOperator:function(e){return s._isHavingSpecialOperator(e)},isMatch:function(e,n,t){var r;if(!t.or)return s._query(e,n,t);for(r=0;r<n.$or.length;r++)if(s._query(e,n.$or[r],t))return!0;return!1}};var a={};a={_count:function(e,n,t,i){var o,a,u=s.isHavingSpecialOperator(n);if(!r.isObject(n)||r.isArray(n)||r.isFunction(n))return void(i&&i("query is not a valid object!",0));for(o=0,a=0;a<e.data.length;a++)s.isMatch(e.data[a],n,u)&&(o+=1);i&&i(null,o)},count:function(e,n,t,i){var o=e.db;i&&!r.isFunction(i)?i=void 0:i||r.isFunction(t)?!i&&r.isFunction(t)&&(i=t,t={}):i=void 0,!r.isArray(t)&&r.isObject(t)||(t={}),a._count(o,n,t,i)}};var u={};u={_delete:function(e,n,t,o,a){var u,c,l,f,p=s.isHavingSpecialOperator(t);if(!r.isObject(t)||r.isArray(t))return void(a&&a(null,null));if(r.isEmpty(t))return l=[],o.many?(u=e.data.length,l=r.clone(e.data),e.data.length=0):(u=1,l=e.data.splice(0,1)),i.fire(n,"change",l),i.fire(n,"delete",l),void(a&&a(null,u));for(u=0,l=[],c=e.data.length,f=0;c>f&&(!s.isMatch(e.data[f],t,p)||(l.push(e.data.splice(f,1)),u+=1,f--,c-=1,o.many));f++);i.fire(n,"change",l),i.fire(n,"delete",l),a&&a(null,u)},"delete":function(e,n,t,i,o){var s=e.db,a=e.eventQ;o&&!r.isFunction(o)?o=void 0:o||r.isFunction(i)?!o&&r.isFunction(i)&&(o=i,i={}):o=void 0,!r.isArray(i)&&r.isObject(i)||(i={}),i.many=n,u._delete(s,a,t,i,o)}};var c={};c={_initCursor:function(){return{query:{}}},_process:function(e,n){var t,i,o=e.cursor.query,a=e.db,u=s.isHavingSpecialOperator(o);if(r.isArray(o)||r.isFunction(o)||!r.isObject(o))return void n("This query isn't a valid Cursor query object");for(t=[],i=0;i<a.data.length;i++)s.isMatch(a.data[i],o,u)&&t.push(a.data[i]);n(null,t)},find:function(e,n){e.cursor||(e.cursor=c._initCursor()),e.cursor.query=n},toArray:function(e,n){r.isFunction(n)&&c._process(e,n)}};var l={};l={_schema:function(){return{data:[]}},_isNewId:function(e,n){var t,r=!0;for(t=0;t<e.data.length;t++)if(e.data[t]._id===n){r=!1;break}return r},_insert:function(e,n,t,o,s){var a,u,c,f;for(a=[],!r.isArray(t)&&r.isObject(t)?a.push(t):a=t,u=[],f=0;f<a.length;f++)if(r.isObject(a[f]))if(a[f]._id){if(l._isNewId(e,a[f]._id)&&(e.data.push(r.extend({},a[f])),u.push(r.extend({},a[f])),!o.many))break}else if(c=r.token(),e.data.push(r.extend({_id:c},a[f])),u.push(r.extend({_id:c},a[f])),!o.many)break;i.fire(n,"change",u),i.fire(n,"insert",u),s&&s(null,u)},insert:function(e,n,t,i,o){var s=e.db,a=e.eventQ;o&&!r.isFunction(o)?o=void 0:o||r.isFunction(i)?!o&&r.isFunction(i)&&(o=i,i={}):o=void 0,!r.isArray(i)&&r.isObject(i)||(i={}),i.many=n,(r.isArray(t)||r.isObject(t))&&l._insert(s,a,t,i,o)}};var f={};f={_pull:function(e,n){var t,i,o,s,a,u,c;for(t in n)if(r.isObject(n[t])&&!r.isArray(e[t])){if(!e[t])continue;f._pull(e[t],n[t])}else if(hasOwnProperty.call(n,t)){if(!e[t]||!r.isArray(e[t]))continue;if("boolean"==typeof n[t]||"number"==typeof n[t]||"string"==typeof n[t]){s=e[t].indexOf(n[t]),s>-1&&e[t].splice(s,1);continue}if(r.isObject(n[t])&&!r.keys(n[t])[0].match(/^\$/)){for(c=e[t].length-1;c>=0&&r.isObject(e[t][c]);c--){o=!0;for(i in n[t])if(e[t][c][i]!==n[t][i]){o=!1;break}o&&e[t].splice(c,1)}continue}if(r.isObject(n[t])){switch(a=r.keys(n[t])[0]){case"$eq":s=e[t].indexOf(n[t].$eq),s>-1&&e[t].splice(s,1);break;case"$gt":for(c=e[t].length-1;c>=0;c--)e[t][c]>n[t].$gt&&e[t].splice(c,1);break;case"$gte":for(c=e[t].length-1;c>=0;c--)e[t][c]>=n[t].$gte&&e[t].splice(c,1);break;case"$lt":for(c=e[t].length-1;c>=0;c--)e[t][c]<n[t].$lt&&e[t].splice(c,1);break;case"$lte":for(c=e[t].length-1;c>=0;c--)e[t][c]<=n[t].$lte&&e[t].splice(c,1);break;case"$ne":for(c=e[t].length-1;c>=0;c--)e[t][c]!==n[t].$ne&&e[t].splice(c,1);break;case"$in":if(!r.isArray(n[t].$in))break;for(c=0;c<n[t].$in.length;c++)s=e[t].indexOf(n[t].$in[c]),s>-1&&e[t].splice(s,1);break;case"$nin":if(!r.isArray(n[t].$nin))break;for(u=[],c=0;c<n[t].$nin.length;c++)s=e[t].indexOf(n[t].$nin[c]),s>-1&&u.push(n[t].$nin[c]);e[t]=r.clone(u);break;default:throw new Error('_update._pull: the operator "'+a+'" is not supported!')}continue}}return e},_push:function(e,n){var t,i,o,s,a;for(t in n)if(i=r.keys(n[t]),r.isArray(n[t])||!r.isObject(n[t])||i[0].match(/^\$/)){if(hasOwnProperty.call(n,t)){if(e[t]||(e[t]=[]),"boolean"==typeof n[t]||"number"==typeof n[t]||"string"==typeof n[t]){e[t].push(n[t]);continue}if(r.isArray(n[t])){e[t].push(r.clone(n[t]));continue}if(r.isObject(n[t])&&r.isArray(n[t].$each)){for(o=n[t].$position,(void 0===o||"number"!=typeof o||0>o)&&(o=e[t].length),s=n[t].$slice,void 0!==s&&"number"==typeof o||(s=null),a=n[t].$each.length-1;a>=0;a--)e[t].splice(o,0,n[t].$each[a]);s>0?e[t].splice(s,e[t].length-s):0===s?e[t].length=0:0>s&&e[t].splice(0,e[t].length+s)}}}else e[t]||(e[t]={}),f._push(e[t],n[t]);return e},_apply:function(e,n,t){var i,o,s;for(i in n)if(!r.isArray(n[i])&&r.isObject(n[i])){if(!(e[i]||"$rename"!==t&&"$unset"!==t&&"$pop"!==t))break;e[i]||(e[i]={}),f._apply(e[i],n[i],t)}else if(hasOwnProperty.call(n,i))switch(t){case"$inc":"number"==typeof e[i]?e[i]+=n[i]:e[i]=n[i];break;case"$mul":"number"==typeof e[i]?e[i]*=n[i]:e[i]=0;break;case"$rename":e[i]&&(e[n[i]]=e[i],delete e[i]);break;case"$set":r.isArray(n[i])?e[i]=r.clone(n[i]):e[i]=n[i];break;case"$unset":e[i]&&delete e[i];break;case"$min":(!e[i]||"number"==typeof e[i]&&n[i]<e[i])&&(e[i]=n[i]);break;case"$max":(!e[i]||"number"==typeof e[i]&&n[i]>e[i])&&(e[i]=n[i]);break;case"$pop":r.isArray(e[i])&&(1===n[i]?e[i].pop():-1===n[i]&&e[i].shift());break;case"$pullAll":if(r.isArray(e[i])&&r.isArray(n[i]))for(o=0;o<n[i].length;o++)for(s=e[i].length-1;s>=0;s--)e[i][s]===n[i][o]&&e[i].splice(s,1);break;default:throw new Error('_update._apply: the operator "'+t+'" is unknown!')}return e},_replace:function(e,n){return e=r.extend({_id:e._id},n)},_applyTime:function(e,n){var t,i;for(t in n)i=r.keys(n[t])[0],r.isObject(n[t])&&"$type"!==i?(e[t]||(e[t]={}),f._applyTime(e[t],n[t])):hasOwnProperty.call(n,t)&&("timestamp"===n[t][i]?e[t]=Date.now():e[t]=(new Date).toISOString());return e},_updateThisDoc:function(e,n){var t=r.keys(n);if(!t[0].match(/^\$/))return f._replace(e,n);switch(t[0]){case"$inc":return f._apply(e,n.$inc,"$inc");case"$mul":return f._apply(e,n.$mul,"$mul");case"$rename":return f._apply(e,n.$rename,"$rename");case"$set":return f._apply(e,n.$set,"$set");case"$unset":return f._apply(e,n.$unset,"$unset");case"$min":return f._apply(e,n.$min,"$min");case"$max":return f._apply(e,n.$max,"$max");case"$currentDate":return f._applyTime(e,n.$currentDate);case"$pop":return f._apply(e,n.$pop,"$pop");case"$pullAll":return f._apply(e,n.$pullAll,"$pullAll");case"$pull":return f._pull(e,n.$pull,"$pull");case"$push":return f._push(e,n.$push,"$push");default:throw new Error('The Update Operator "'+t[0]+"\" isn't supported!")}},_update:function(e,n,t,o,a,u){var c,l,p,h=s.isHavingSpecialOperator(t);if(r.isArray(t)||r.isFunction(t)||!r.isObject(t))return void(u&&u("filter is not a valid object!"));if(r.isArray(o)||r.isFunction(o)||!r.isObject(o))return void(u&&u("update is not a valid object!"));for(l=[],p=0;p<e.data.length&&(!s.isMatch(e.data[p],t,h)||(c=f._updateThisDoc(e.data[p],o),l.push(r.extend({},c)),a.many));p++);i.fire(n,"change",l),i.fire(n,"update",l),u&&u(null,l)},update:function(e,n,t,i,o,s){var a=e.db,u=e.eventQ;s&&!r.isFunction(s)?s=void 0:s||r.isFunction(o)?!s&&r.isFunction(o)&&(s=o,o={}):s=void 0,!r.isArray(o)&&r.isObject(o)||(o={}),o.many=n,f._update(a,u,t,i,o,s)}};var p=function(e){e.db=l._schema(),e.eventQ=i.setEventListenerList()};return n.Create=function(){this.db;var e=function(e,n,t){!this.db||arguments.length<1||a.count(this,e,n,t)},n=function(e,n,t){!this.db||arguments.length<1||u["delete"](this,!0,e,n,t)},t=function(e,n,t){!this.db||arguments.length<1||u["delete"](this,!1,e,n,t)},r=function(e,n,t){this.db||p(this),arguments.length<1||l.insert(this,!0,e,n,t)},o=function(e,n,t){this.db||p(this),arguments.length<1||l.insert(this,!1,e,n,t)},s=function(e,n,t,r){!this.db||arguments.length<2||f.update(this,!0,e,n,t,r)},h=function(e,n,t,r){!this.db||arguments.length<2||f.update(this,!1,e,n,t,r)},d=function(e){return e=e||{},this.db?(c.find(this,e),this):this},y=function(e){this.db&&c.toArray(this,e)},g=function(e,n){this.db||p(this),i.addEventListener(this.eventQ,e,n)},$=function(e,n){this.db||p(this),i.addOneTimeEventListener(this.eventQ,e,n)},v=function(e,n){this.db||p(this),i.removeEventListener(this.eventQ,e,n)};return{count:e,deleteMany:n,deleteOne:t,insertMany:r,insertOne:o,updateMany:s,updateOne:h,find:d,toArray:y,addEventListener:g,addOneTimeEventListener:$,removeEventListener:v,on:g,one:$,off:v}},n});