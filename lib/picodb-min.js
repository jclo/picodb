/**
 * PicoDB v0.0.0
 *
 * @license
 * PicoDB is a tiny in-memory database that stores JSON documents.
 * Copyright (c) 2016 jclo <jclo@mobilabs.fr> (http://www.mobilabs.fr/).
 * Released under the MIT license. You may obtain a copy of the License
 * at: http://www.opensource.org/licenses/mit-license.php).
 */
!function(t,n){"use strict";"function"==typeof define&&define.amd?define([""],n):"object"==typeof exports?module.exports=n(t):t.PicoDB=n(t)}(this,function(t){"use strict";var n,e;e=t.PicoDB,n=function(){},n.noConflict=function(){return t.PicoDB=e,this},n.VERSION="0.0.0";var i={};i={isUndefined:function(t){return void 0===t},isNull:function(t){return null===t},isBoolean:function(t){return t===!0||t===!1||"[object Boolean]"===Object.prototype.toString.call(t)},isString:function(t){return"[object String]"===Object.prototype.toString.call(t)},isNumber:function(t){return"[object Number]"===Object.prototype.toString.call(t)},isNaN:function(t){return i.isNumber(t)&&t!==+t},isOdd:function(t){var n=t%2;return t===parseFloat(t)?!!n:void 0},isObject:function(t){var n=typeof t;return"function"===n||"object"===n&&!!t},isMath:function(t){return"[object Math]"===Object.prototype.toString.call(t)},isDate:function(t){return"[object Date]"===Object.prototype.toString.call(t)},isArray:Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},isFunction:function(t){return"[object Function]"===Object.prototype.toString.call(t)},isEmpty:function(t){if(null===t)return!0;if(i.isArray(t)||i.isString(t))return 0===t.length;for(var n in t)if(t.hasOwnProperty(n))return!1;return!0},contains:function(t,n){return-1!==t.indexOf(n)},clone:function(t){var n,e;if(!i.isObject(t))return null;n=i.isArray(t)?[]:{};for(e in t)i.isObject(t[e])?n[e]=i.clone(t[e]):n[e]=t[e];return n},keys:function(t){return Object.keys(t)},extend:function(t){if(!i.isObject(t))return t;for(var n,e,r=1,s=arguments.length;s>r;r++){n=arguments[r];for(e in n)i.isObject(arguments[r][e])?(void 0===t[e]&&(t[e]={}),i.extend(t[e],arguments[r][e])):hasOwnProperty.call(n,e)&&(t[e]=n[e])}return t},token:function(){return Math.random().toString(36).substr(2)}};var r={};r={_isValidEvent:function(t,n,e){return!(!t.hasOwnProperty(n)||"function"!=typeof e)},setEventListenerList:function(){return{insert:{listeners:[],listenersOnce:[]},update:{listeners:[],listenersOnce:[]},"delete":{listeners:[],listenersOnce:[]},change:{listeners:[],listenersOnce:[]}}},fire:function(t,n,e){var i;if(t[n]){for(i=0;i<t[n].listeners.length;i++)t[n].listeners[i](e);for(i=0;i<t[n].listenersOnce.length;i++)t[n].listenersOnce[i](e);t[n].listenersOnce.splice(0,t[n].listenersOnce.length)}},addEventListener:function(t,n,e){r._isValidEvent(t,n,e)&&t[n].listeners.push(e)},addOneTimeEventListener:function(t,n,e){r._isValidEvent(t,n,e)&&t[n].listenersOnce.push(e)},removeEventListener:function(t,n,e){var i;r._isValidEvent(t,n,e)&&(i=t[n].listeners.indexOf(e),i>=0&&t[n].listeners.splice(i,1))}},r.on=r.addEventListener,r.one=r.addOneTimeEventListener,r.off=r.removeEventListener;var s={};s={_isQueryOperator:function(t){var n,e=i.keys(t)[0];if(!e||!e.match(/^\$/))return!1;if(n=["$eq","$gt","$gte","$lt","$lte","$ne","$in","$nin"],i.contains(n,e))return e;throw new Error('The query operator "'+e+"\" isn't supported!")},_isMatchOp:function(t,n,e){switch(t){case!1:return n===e;case"$eq":return n===e.$eq;case"$gt":return n>e.$gt;case"$gte":return n>=e.$gte;case"$lt":return n<e.$lt;case"$lte":return n<=e.$lte;default:throw new Error("_query._isMatchOp: must never occur!")}},_isMatch:function(t,n){function e(t,n){var r,o;for(r in n){if(!t[r])return!1;if(o=s._isQueryOperator(n[r]),i.isObject(n[r])&&!o){if(!e(t[r],n[r]))return!1}else if(!s._isMatchOp(o,t[r],n[r]))return!1}return!0}return e(t,n)},isMatch:function(t,n){return s._isMatch(t,n)}};var o={};o={_count:function(t,n,e,r){var o,u;if(!i.isObject(n)||i.isArray(n)||i.isFunction(n))return void(r&&r("query is not a valid object!",0));for(o=0,u=0;u<t.data.length;u++)s.isMatch(t.data[u],n)&&(o+=1);r&&r(null,o)},count:function(t,n,e,r){var s=t.db;r&&!i.isFunction(r)?r=void 0:r||i.isFunction(e)?!r&&i.isFunction(e)&&(r=e,e={}):r=void 0,!i.isArray(e)&&i.isObject(e)||(e={}),o._count(s,n,e,r)}};var u={};u={_delete:function(t,n,e,o,u){var a,c,f,d;if(!i.isObject(e)||i.isArray(e))return void(u&&u(null,null));if(i.isEmpty(e))return f=[],o.many?(a=t.data.length,f=i.clone(t.data),t.data.length=0):(a=1,f=t.data.splice(0,1)),r.fire(n,"change",f),r.fire(n,"delete",f),void(u&&u(null,a));for(a=0,f=[],c=t.data.length,d=0;c>d&&(!s.isMatch(t.data[d],e)||(f.push(t.data.splice(d,1)),a+=1,d--,c-=1,o.many));d++);r.fire(n,"change",f),r.fire(n,"delete",f),u&&u(null,a)},"delete":function(t,n,e,r,s){var o=t.db,a=t.eventQ;s&&!i.isFunction(s)?s=void 0:s||i.isFunction(r)?!s&&i.isFunction(r)&&(s=r,r={}):s=void 0,!i.isArray(r)&&i.isObject(r)||(r={}),r.many=n,u._delete(o,a,e,r,s)}};var a={};a={_initCursor:function(){return{query:{}}},_process:function(t,n){var e,r,o=t.cursor.query,u=t.db;if(i.isArray(o)||i.isFunction(o)||!i.isObject(o))return void n("This query isn't a valid Cursor query object");for(e=[],r=0;r<u.data.length;r++)s.isMatch(u.data[r],o)&&e.push(u.data[r]);n(null,e)},find:function(t,n){t.cursor||(t.cursor=a._initCursor()),t.cursor.query=n},toArray:function(t,n){i.isFunction(n)&&a._process(t,n)}};var c={};c={_schema:function(){return{data:[]}},_isNewId:function(t,n){var e,i=!0;for(e=0;e<t.data.length;e++)if(t.data[e]._id===n){i=!1;break}return i},_insert:function(t,n,e,s,o){var u,a,f,d,l;for(u=[],!i.isArray(e)&&i.isObject(e)?u.push(e):u=e,a=[],l=0;l<u.length;l++)if(i.isObject(u[l]))if(u[l]._id){if(c._isNewId(t,u[l]._id)&&(t.data.push(u[l]),a.push(u[l]),!s.many))break}else{f={_id:i.token()};for(d in u[l])u[l].hasOwnProperty(d)&&(f[d]=u[l][d]);if(t.data.push(f),a.push(f),!s.many)break}r.fire(n,"change",a),r.fire(n,"insert",a),o&&o(null,a)},insert:function(t,n,e,r,s){var o=t.db,u=t.eventQ;s&&!i.isFunction(s)?s=void 0:s||i.isFunction(r)?!s&&i.isFunction(r)&&(s=r,r={}):s=void 0,!i.isArray(r)&&i.isObject(r)||(r={}),r.many=n,(i.isArray(e)||i.isObject(e))&&c._insert(o,u,e,r,s)}};var f={};f={_set:function(t,n){var e;for(e in n)n.hasOwnProperty(e)&&"_id"!==e&&(t[e]=n[e]);return t},_unset:function(t,n){var e;for(e in n)n.hasOwnProperty(e)&&"_id"!==e&&delete t[e];return t},_replace:function(t,n){var e;for(e in t)"_id"!==e&&delete t[e];for(e in n)n.hasOwnProperty(e)&&"_id"!==e&&(t[e]=n[e]);return t},_updateThisDoc:function(t,n){var e=i.keys(n);return"$set"===e[0]?f._set(t,n.$set):"$unset"===e[0]?f._unset(t,n.$unset):f._replace(t,n)},_update:function(t,n,e,o,u,a){var c,d;if(i.isArray(e)||i.isFunction(e)||!i.isObject(e))return void(a&&a("filter is not a valid object!"));if(i.isArray(o)||i.isFunction(o)||!i.isObject(o))return void(a&&a("update is not a valid object!"));for(c=[],d=0;d<t.data.length&&(!s.isMatch(t.data[d],e)||(c.push(f._updateThisDoc(t.data[d],o)),u.many));d++);r.fire(n,"change",c),r.fire(n,"update",c),a&&a(null,c)},update:function(t,n,e,r,s,o){var u=t.db,a=t.eventQ;o&&!i.isFunction(o)?o=void 0:o||i.isFunction(s)?!o&&i.isFunction(s)&&(o=s,s={}):o=void 0,!i.isArray(s)&&i.isObject(s)||(s={}),s.many=n,f._update(u,a,e,r,s,o)}};var d=function(t){t.db=c._schema(),t.eventQ=r.setEventListenerList()};return n.Create=function(){this.db;var t=function(t,n,e){!this.db||arguments.length<1||o.count(this,t,n,e)},n=function(t,n,e){!this.db||arguments.length<1||u["delete"](this,!0,t,n,e)},e=function(t,n,e){!this.db||arguments.length<1||u["delete"](this,!1,t,n,e)},i=function(t,n,e){this.db||d(this),arguments.length<1||c.insert(this,!0,t,n,e)},s=function(t,n,e){this.db||d(this),arguments.length<1||c.insert(this,!1,t,n,e)},l=function(t,n,e,i){!this.db||arguments.length<2||f.update(this,!0,t,n,e,i)},h=function(t,n,e,i){!this.db||arguments.length<2||f.update(this,!1,t,n,e,i)},v=function(t){return t=t||{},this.db?(a.find(this,t),this):this},p=function(t){this.db&&a.toArray(this,t)},b=function(t,n){this.db||d(this),r.addEventListener(this.eventQ,t,n)},y=function(t,n){this.db||d(this),r.addOneTimeEventListener(this.eventQ,t,n)},O=function(t,n){this.db||d(this),r.removeEventListener(this.eventQ,t,n)};return{count:t,deleteMany:n,deleteOne:e,insertMany:i,insertOne:s,updateMany:l,updateOne:h,find:v,toArray:p,addEventListener:b,addOneTimeEventListener:y,removeEventListener:O,on:b,one:y,off:O}},n});