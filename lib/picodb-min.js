/**
 * PicoDB v0.8.1
 *
 * @license
 * PicoDB is a tiny in-memory database that stores JSON documents.
 * Copyright (c) 2016 jclo <jclo@mobilabs.fr> (http://www.mobilabs.fr/).
 * Released under the MIT license. You may obtain a copy of the License
 * at: http://www.opensource.org/licenses/mit-license.php).
 */
!function(e,t){"use strict";"function"==typeof define&&define.amd?define([""],t):"object"==typeof exports?module.exports=t(e):e.PicoDB=t(e)}(this,function(root){"use strict";var PicoDB,previousPicoDB;previousPicoDB=root.PicoDB,PicoDB=function(){},PicoDB.noConflict=function(){return root.PicoDB=previousPicoDB,this},PicoDB.VERSION="0.8.1";var _={};_={isUndefined:function(e){return void 0===e},isNull:function(e){return null===e},isBoolean:function(e){return e===!0||e===!1||"[object Boolean]"===Object.prototype.toString.call(e)},isString:function(e){return"[object String]"===Object.prototype.toString.call(e)},isNumber:function(e){return"[object Number]"===Object.prototype.toString.call(e)},isNaN:function(e){return _.isNumber(e)&&e!==+e},isOdd:function(e){var t=e%2;return e===parseFloat(e)?!!t:void 0},isObject:function(e){var t=typeof e;return("function"===t||"object"===t)&&!!e},isFunction:function(e){return"[object Function]"===Object.prototype.toString.call(e)},isArray:Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},isMath:function(e){return"[object Math]"===Object.prototype.toString.call(e)},isDate:function(e){return"[object Date]"===Object.prototype.toString.call(e)},isEmpty:function(e){var t;if(null===e)return!0;if(_.isArray(e)||_.isString(e))return 0===e.length;for(t in e)if(e.hasOwnProperty(t))return!1;return!0},clone:function(e){var t,n=_.isArray(e)?[]:{};if(_.isObject(e)){for(t in e)_.isArray(e[t])?n[t]=_.clone(e[t]):_.isObject(e[t])?n[t]=_.extend(e[t]):n[t]=e[t];return n}},extend:function(e){var t,n,r;if(!_.isObject(e))return e;for(r=1;r<arguments.length;r++){t=arguments[r];for(n in t)!_.isArray(arguments[r][n])&&_.isObject(arguments[r][n])?(e[n]=void 0!==e[n]?e[n]:{},_.extend(e[n],arguments[r][n])):hasOwnProperty.call(t,n)&&(e[n]=_.isArray(t[n])?_.clone(t[n]):t[n])}return e},keys:function(e){return Object.keys(e)},forPropIn:function(e,t){_.keys(e).forEach(function(n){({}).hasOwnProperty.call(e,n)&&t(n)})},contains:function(e,t){return e.indexOf(t)!==-1},flatten:function(e,t){var n,r=[],i=0;if(_.isArray(e)){if(t)return[].concat.apply([],e);for(n=0;n<e.length;n++)_.isArray(e[n])?(r=r.concat(_.flatten(e[n])),i=r.length):r[i++]=e[n];return r}},max:function(e){var t,n,r=null;if(_.isArray(e)){for(t=_.flatten(e),n=0;n<t.length;n++)(null===r||r<t[n])&&(r="number"==typeof t[n]?t[n]:r);return null!==r?r:void 0}},min:function(e){var t,n,r=null;if(_.isArray(e)){for(t=_.flatten(e),n=0;n<t.length;n++)(null===r||r>t[n])&&(r="number"==typeof t[n]?t[n]:r);return null!==r?r:void 0}},share:function(e){var t,n,r,i=[];for(n=0;n<e.length;n++)if(t=e[n],!_.contains(i,t)){for(r=1;r<arguments.length&&_.contains(arguments[r],t);r++);r===arguments.length&&i.push(t)}return i},token:function(){return Math.random().toString(36).substr(2)},makeid:function(e){var t,n=_.isNumber(e)?e:16,r="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",i="";for(t=0;t<n;t++)i+=r.charAt(Math.floor(Math.random()*r.length));return i},nop:function(){}};var _event={};_event={_isValidEvent:function(e,t,n){return!(!{}.hasOwnProperty.call(e,t)||"function"!=typeof n)},setEventListenerList:function(){return{insert:{listeners:[],listenersOnce:[]},update:{listeners:[],listenersOnce:[]},delete:{listeners:[],listenersOnce:[]},change:{listeners:[],listenersOnce:[]}}},fire:function(e,t,n){var r;if(e[t]){for(r=0;r<e[t].listeners.length;r++)e[t].listeners[r](n);for(r=0;r<e[t].listenersOnce.length;r++)e[t].listenersOnce[r](n);e[t].listenersOnce.splice(0,e[t].listenersOnce.length)}},addEventListener:function(e,t,n){_event._isValidEvent(e,t,n)&&e[t].listeners.push(n)},addOneTimeEventListener:function(e,t,n){_event._isValidEvent(e,t,n)&&e[t].listenersOnce.push(n)},removeEventListener:function(e,t,n){var r;_event._isValidEvent(e,t,n)&&(r=e[t].listeners.indexOf(n),r>=0&&e[t].listeners.splice(r,1))}},_event.on=_event.addEventListener,_event.one=_event.addOneTimeEventListener,_event.off=_event.removeEventListener;var _geo={};_geo={_lawOfHaversines:function(e,t){var n,r,i=t.coordinates[0],o=e.coordinates[0],a=(o-i)*(Math.PI/180),s=t.coordinates[1]*(Math.PI/180),u=e.coordinates[1]*(Math.PI/180),c=u-s,_=6371e3;return n=Math.sin(c/2)*Math.sin(c/2)+Math.cos(s)*Math.cos(u)*Math.sin(a/2)*Math.sin(a/2),r=2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)),_*r},_lawOfCosines:function(e,t){var n=t.coordinates[0],r=e.coordinates[0],i=(r-n)*(Math.PI/180),o=t.coordinates[1]*(Math.PI/180),a=e.coordinates[1]*(Math.PI/180),s=6371e3;return Math.acos(Math.sin(o)*Math.sin(a)+Math.cos(o)*Math.cos(a)*Math.cos(i))*s},_equirectangularProjection:function(e,t){var n,r,i=t.coordinates[0]*(Math.PI/180),o=e.coordinates[0]*(Math.PI/180),a=t.coordinates[1]*(Math.PI/180),s=e.coordinates[1]*(Math.PI/180),u=6371e3;return n=(o-i)*Math.cos((a+s)/2),r=s-a,Math.sqrt(n*n+r*r)*u},_getDistanceOnEarth:function(e,t){return _geo._lawOfCosines(e,t)},_isPointInPolygon2:function(e,t){var n,r,i,o,a;for(a=0;a<t.length;a++)if(e[0]===t[a][0]&&e[1]===t[a][1])return"vertex";for(n=0,a=1;a<t.length;a++){if(r=t[a-1],i=t[a],r[1]===i[1]&&r[1]===e[1]&&e[0]>Math.min(r[0],i[0])&&e[0]<Math.max(r[0],i[0]))return"boundary";if(e[1]>Math.min(r[1],i[1])&&e[1]<=Math.max(r[1],i[1])&&e[0]<=Math.max(r[0],i[0])&&r[1]!==i[1]){if(o=(e[1]-r[1])*(i[0]-r[0])/(i[1]-r[1])+r[0],o===e[0])return"boundary";(r[0]===i[0]||e[0]<=o)&&(n+=1)}}return n%2!==0?"inside":"outside"},_isPointInPolygon:function(e,t){var n,r,i=0;for(r=0;r<t.length-1;r++)(t[r][1]<=e[1]&&t[r+1][1]>e[1]||t[r][1]>e[1]&&t[r+1][1]<=e[1])&&(n=(e[1]-t[r][1])/(t[r+1][1]-t[r][1]),e[0]<t[r][0]+n*(t[r+1][0]-t[r][0])&&i++);return i%2!==0},_isGeometryInsideGeoObject:function(e,t){var n,r,i,o,a;switch(t.type){case"MultiPolygon":for(r=0;r<e.length;r++)for(i=0;i<e[r].length;i++){for(o=0;o<t.coordinates.length;o++){for(n=!1,a=0;a<t.coordinates[o].length;a++)if(_geo._isPointInPolygon(e[r][i],t.coordinates[o][a])){n=!0;break}if(n)break}if(!n)return!1}return!0;case"Polygon":for(r=0;r<e.length;r++)for(i=0;i<e[r].length;i++){for(n=!1,o=0;o<t.coordinates.length;o++)if(_geo._isPointInPolygon(e[r][i],t.coordinates[o])){n=!0;break}if(!n)return!1}return!0;default:throw new Error('_geo._within: the GeoSpatial $geoWihin operator with a $geometry.type "'+t.type+'" is unknown!')}},_toPolygonCoordinates:function(e){switch(e.type){case"Point":return[[e.coordinates]];case"LineString":return[e.coordinates];case"Polygon":return e.coordinates;case"MultiPoint":return[e.coordinates];case"MultiLineString":return e.coordinates;default:throw new Error('_geo._toPolygonCoordinates: the GeoJSON type "'+e.type+'" is not supported!')}},_box:function(e,t){var n,r;return n=[[[t[0][0],t[0][1]],[t[1][0],t[0][1]],[t[1][0],t[1][1]],[t[0][0],t[1][1]]]],r={type:"Polygon",coordinates:n},_geo._isGeometryInsideGeoObject(_geo._toPolygonCoordinates(e),r)},_polygon:function(e,t){var n;return n={type:"Polygon",coordinates:[t,[t[0][0],t[0][1]]]},_geo._isGeometryInsideGeoObject(_geo._toPolygonCoordinates(e),n)},_center:function(e,t){var n;return n=Math.sqrt(Math.pow(t[0][0]-e.coordinates[0],2)+Math.pow(t[0][1]-e.coordinates[1],2)),n<t[1]},_centerSphere:function(e,t){var n;return n=Math.sqrt(Math.pow(t[0][0]-e.coordinates[0],2)+Math.pow(t[0][1]-e.coordinates[1],2)),n<t[1]/Math.PI*180},_within:function(e,t){switch(e.type){case"Point":return _geo._isGeometryInsideGeoObject(_geo._toPolygonCoordinates(e),t);case"LineString":return _geo._isGeometryInsideGeoObject(_geo._toPolygonCoordinates(e),t);case"Polygon":return _geo._isGeometryInsideGeoObject(_geo._toPolygonCoordinates(e),t);case"MultiPoint":return _geo._isGeometryInsideGeoObject(_geo._toPolygonCoordinates(e),t);case"MultiLineString":return _geo._isGeometryInsideGeoObject(_geo._toPolygonCoordinates(e),t);case"MultiPolygon":return!1;case"GeometryCollection":return!1;default:return!1}},_interLineString:function(e,t){var n,r,i,o,a;for(o=0;o<e.coordinates.length;o++){for(a=0;a<t.coordinates.length;a++)if(i=!1,_geo._isPointInPolygon(e.coordinates[o],t.coordinates[a])){if(n=!0,i=!0,n&&r)return!0;break}if(!i&&(r=!0,n&&r))return!0}return!1},_interPolygon:function(e,t){var n,r,i,o,a,s;for(o=0;o<e.coordinates.length;o++)for(a=0;a<e.coordinates[o].length;a++){for(s=0;s<t.coordinates.length;s++)if(i=!1,_geo._isPointInPolygon(e.coordinates[o][a],t.coordinates[s])){if(n=!0,i=!0,n&&r)return!0;break}if(!i&&(r=!0,n&&r))return!0}return!1},_intersects:function(e,t){switch(e.type){case"Point":return!1;case"LineString":return _geo._interLineString(e,t);case"Polygon":return _geo._interPolygon(e,t);case"MultiPoint":return!1;case"MultiLineString":return!1;case"MultiPolygon":return!1;case"GeometryCollection":return!1;default:return!1}},_isPointNear:function(e,t,n,r){var i;return void 0===n&&void 0===r||!(n<r)&&(i=_geo._getDistanceOnEarth(e,t),(!r||i>=r)&&(!n||i<=n))},_geoNear:function(e,t,n,r){switch(e.type){case"Point":return _geo._isPointNear(e,t,n,r);default:return!1}},_geoWithin:function(e,t){var n=_.keys(t)[0];if(!_.isObject(t))return!1;switch(n){case"$geometry":return _geo._within(e,t.$geometry);case"$box":return _geo._box(e,t.$box);case"$polygon":return _geo._polygon(e,t.$polygon);case"$center":return _geo._center(e,t.$center);case"$centerSphere":return _geo._centerSphere(e,t.$centerSphere);default:throw new Error('_geo._geoWithin: the GeoSpatial $geoWihin operator "'+n+'" is unknown!')}},_geoIntersects:function(e,t){if(!{}.hasOwnProperty.call(t,"$geometry"))return!1;switch(t.$geometry.type){case"Polygon":return _geo._intersects(e,t.$geometry);default:throw new Error('_geo._geoIntersects: the GeoSpatial $geoIntersects type "'+t.$geometry.type+'" is not supported!')}},_near:function(e,t){if(!{}.hasOwnProperty.call(t,"$geometry"))return!1;switch(t.$geometry.type){case"Point":return _geo._geoNear(e,t.$geometry,t.$maxDistance,t.$minDistance);default:return!1}},_query:function(e,t){var n;return _.forPropIn(t,function(r){switch(r){case"$geoWithin":n=_geo._geoWithin(e,t[r]);break;case"$geoIntersects":n=_geo._geoIntersects(e,t[r]);break;case"$near":n=_geo._near(e,t[r]);break;case"$nearSphere":n=!1;break;default:throw new Error('_geo._query: the Geo Operator "'+r+'" is unknown!')}}),n},query:function(e,t){return _geo._query(e,t)}};var _project={};_project={_include:function(e,t,n){return _.forPropIn(t,function(r){e[r]&&(_.isObject(t[r])?(n[r]={},_project._include(e[r],t[r],n[r])):1===t[r]&&(_.isObject(e[r])?n[r]=_.clone(e[r]):e[r]&&(n[r]=e[r])))}),n},_exclude:function(e,t,n){return _.forPropIn(e,function(r){void 0!==t[r]?_.isObject(t[r])&&(n[r]={},_project._exclude(e[r],t[r],n[r])):_.isObject(e[r])?n[r]=_.clone(e[r]):n[r]=e[r]}),n},setProjection:function(e,t){return t?void 0!==e._id?e:_.extend({_id:1},e):e},isProjectionTypeInclude:function(e){var t;for(t in e)if(_.isObject(e[t])){if(_project.isProjectionTypeInclude(e[t]))return!0}else if(e[t])return!0;return!1},add:function(e,t,n){_.isEmpty(n.value)?e.push(_.clone(t)):n.type?e.push(_project._include(t,n.value,{})):e.push(_project._exclude(t,n.value,{}))}};var _query={};_query={_isHavingNotOperator:function(e){var t,n,r,i,o,a,s=["$ne","$nin","$not"];if(n=[],_.contains(_.keys(e),"$or"))for(t=e.$or,o=0;o<t.length;o++)_.forPropIn(t[o],function(e){for(a=0;a<s.length;a++)r=new RegExp('"\\'+s[a]+'":'),i=JSON.stringify(t[o]).match(r),i&&n.push(e)});else _.forPropIn(e,function(t){for(a=0;a<s.length;a++)r=new RegExp('"\\'+s[a]+'":'),i=JSON.stringify(e[t]).match(r),i&&n.push(t)});return 0!==n.length&&n},_isHavingOrOperator:function(e){return!(!e.$or||!_.isArray(e.$or))&&e.$or},_isHavingSpecialOperator:function(e){return{not:_query._isHavingNotOperator(e),or:_query._isHavingOrOperator(e)}},_isConditionTrue:function(e,t,n){switch(n){case"$eq":return e===t;case"$gt":return e>t;case"$gte":return e>=t;case"$lt":return e<t;case"$lte":return e<=t;case"$ne":return e!==t;case"$in":return _.isArray(e)?!_.isEmpty(_.share(t,e)):_.contains(t,e);case"$nin":return _.isArray(e)?_.isEmpty(_.share(t,e)):!_.contains(t,e);case"$not":return!_query._areConditionsTrue(e,t);case"$exists":return t;case"$geoWithin":return _geo.query(e,{$geoWithin:t});case"$geoIntersects":return _geo.query(e,{$geoIntersects:t});case"$near":return _geo.query(e,{$near:t});case"$nearSphere":return _geo.query(e,{$nearSphere:t});default:throw new Error('_query._isConditionTrue: the operator "'+n+'" is unknown!')}},_areConditionsTrue:function(e,t){var n;if(!_.isArray(t)&&!_.isObject(t))return e===t;for(n in t)if(!_query._isConditionTrue(e,t[n],n))return!1;return!0},_query:function(e,t,n){function r(e,t){var a;for(a in t)if(0===o&&(i=a),e[a]){if(_.isObject(t[a])&&!_.keys(t[a])[0].match(/^\$/)){if(o+=1,r(e[a],t[a])){if(n.or)return!0}else if(o-=1,!n.or)return!1}else if(_query._areConditionsTrue(e[a],t[a])){if(n.or)return!0}else if(!n.or)return!1}else{if(!n.not||!_.contains(n.not,i))return!1;if(n.or)return!0}return!n.or}var i,o=0;return r(e,t)},isHavingSpecialOperator:function(e){return _query._isHavingSpecialOperator(e)},isMatch:function(e,t,n){var r;if(!n.or)return _query._query(e,t,n);for(r=0;r<t.$or.length;r++)if(_query._query(e,t.$or[r],n))return!0;return!1}};var _count={};_count={_count:function(e,t,n,r){var i,o,a=_query.isHavingSpecialOperator(t);if(!_.isObject(t)||_.isArray(t)||_.isFunction(t))return void(r&&r("query is not a valid object!",0));for(i=0,o=0;o<e.data.length;o++)_query.isMatch(e.data[o],t,a)&&(i+=1);r&&r(null,i)},count:function(e,t,n,r){var i=e.db;r&&!_.isFunction(r)?r=void 0:r||_.isFunction(n)?!r&&_.isFunction(n)&&(r=n,n={}):r=void 0,!_.isArray(n)&&_.isObject(n)||(n={}),_count._count(i,t,n,r)}};var _delete={};_delete={_delete:function(e,t,n,r,i){var o,a,s,u,c=_query.isHavingSpecialOperator(n);if(!_.isObject(n)||_.isArray(n))return void(i&&i(null,null));if(_.isEmpty(n))return s=[],r.many?(o=e.data.length,s=_.clone(e.data),e.data.length=0):(o=1,s=e.data.splice(0,1)),_event.fire(t,"change",s),_event.fire(t,"delete",s),void(i&&i(null,o));for(o=0,s=[],a=e.data.length,u=0;u<a&&(!_query.isMatch(e.data[u],n,c)||(s.push(e.data.splice(u,1)),o+=1,u-=1,a-=1,r.many));u++);_event.fire(t,"change",s),_event.fire(t,"delete",s),i&&i(null,o)},delete:function(e,t,n,r,i){var o=e.db,a=e.eventQ;i&&!_.isFunction(i)?i=void 0:i||_.isFunction(r)?!i&&_.isFunction(r)&&(i=r,r={}):i=void 0,!_.isArray(r)&&_.isObject(r)||(r={}),r.many=t,_delete._delete(o,a,n,r,i)}};var _find={};_find={_initCursor:function(){return{query:{},projection:{type:null,value:null}}},_process:function(e,t){var n,r,i=e.cursor.query,o=e.cursor.projection,a=e.db,s=_query.isHavingSpecialOperator(i);if(_.isArray(i)||_.isFunction(i)||!_.isObject(i))return void t("This query isn't a valid Cursor query object");for(n=[],r=0;r<a.data.length;r++)_query.isMatch(a.data[r],i,s)&&_project.add(n,a.data[r],o);t(null,n)},find:function(e,t,n){e.cursor||(e.cursor=_find._initCursor()),e.cursor.query=!_.isArray(t)&&_.isObject(t)?t:{},!_.isArray(n)&&_.isObject(n)?(e.cursor.projection.type=_project.isProjectionTypeInclude(n),e.cursor.projection.value=_project.setProjection(n,e.cursor.projection.type)):e.cursor.projection.value={}},toArray:function(e,t){_.isFunction(t)&&_find._process(e,t)}};var _insert={};_insert={_schema:function(){return{data:[]}},_isNewId:function(e,t){var n,r=!0;for(n=0;n<e.data.length;n++)if(e.data[n]._id===t){r=!1;break}return r},_insert:function(e,t,n,r,i){var o,a,s,u;for(o=[],!_.isArray(n)&&_.isObject(n)?o.push(n):o=n,a=[],u=0;u<o.length;u++)if(_.isObject(o[u]))if(o[u]._id){if(_insert._isNewId(e,o[u]._id)&&(e.data.push(_.extend({},o[u])),a.push(_.extend({},o[u])),!r.many))break}else if(s=_.token(),e.data.push(_.extend({_id:s},o[u])),a.push(_.extend({_id:s},o[u])),!r.many)break;_event.fire(t,"change",a),_event.fire(t,"insert",a),i&&i(null,a)},insert:function(e,t,n,r,i){var o=e.db,a=e.eventQ;i&&!_.isFunction(i)?i=void 0:i||_.isFunction(r)?!i&&_.isFunction(r)&&(i=r,r={}):i=void 0,!_.isArray(r)&&_.isObject(r)||(r={}),r.many=t,(_.isArray(n)||_.isObject(n))&&_insert._insert(o,a,n,r,i)}};var _update={};_update={_pull:function(e,t){var n,r,i,o,a,s,u;for(n in t)if(_.isObject(t[n])&&!_.isArray(e[n]))e[n]&&_update._pull(e[n],t[n]);else if(hasOwnProperty.call(t,n)){if(!e[n]||!_.isArray(e[n]))continue;if("boolean"==typeof t[n]||"number"==typeof t[n]||"string"==typeof t[n]){o=e[n].indexOf(t[n]),o>-1&&e[n].splice(o,1);continue}if(_.isObject(t[n])&&!_.keys(t[n])[0].match(/^\$/)){for(u=e[n].length-1;u>=0&&_.isObject(e[n][u]);u--){i=!0;for(r in t[n])if(e[n][u][r]!==t[n][r]){i=!1;break}i&&e[n].splice(u,1)}continue}if(_.isObject(t[n])){switch(a=_.keys(t[n])[0]){case"$eq":o=e[n].indexOf(t[n].$eq),o>-1&&e[n].splice(o,1);break;case"$gt":for(u=e[n].length-1;u>=0;u--)e[n][u]>t[n].$gt&&e[n].splice(u,1);break;case"$gte":for(u=e[n].length-1;u>=0;u--)e[n][u]>=t[n].$gte&&e[n].splice(u,1);break;case"$lt":for(u=e[n].length-1;u>=0;u--)e[n][u]<t[n].$lt&&e[n].splice(u,1);break;case"$lte":for(u=e[n].length-1;u>=0;u--)e[n][u]<=t[n].$lte&&e[n].splice(u,1);break;case"$ne":for(u=e[n].length-1;u>=0;u--)e[n][u]!==t[n].$ne&&e[n].splice(u,1);break;case"$in":if(!_.isArray(t[n].$in))break;for(u=0;u<t[n].$in.length;u++)o=e[n].indexOf(t[n].$in[u]),o>-1&&e[n].splice(o,1);break;case"$nin":if(!_.isArray(t[n].$nin))break;for(s=[],u=0;u<t[n].$nin.length;u++)o=e[n].indexOf(t[n].$nin[u]),o>-1&&s.push(t[n].$nin[u]);e[n]=_.clone(s);break;default:throw new Error('_update._pull: the operator "'+a+'" is not supported!')}continue}}return e},_push:function(e,t){var n,r,i,o,a;for(n in t)if({}.hasOwnProperty.call(t,n))if(r=_.keys(t[n]),_.isArray(t[n])||!_.isObject(t[n])||r[0].match(/^\$/)){if(hasOwnProperty.call(t,n)){if(e[n]||(e[n]=[]),"boolean"==typeof t[n]||"number"==typeof t[n]||"string"==typeof t[n]){e[n].push(t[n]);continue}if(_.isArray(t[n])){e[n].push(_.clone(t[n]));continue}if(_.isObject(t[n])&&_.isArray(t[n].$each)){for(i=t[n].$position,(void 0===i||"number"!=typeof i||i<0)&&(i=e[n].length),o=t[n].$slice,void 0!==o&&"number"==typeof i||(o=null),a=t[n].$each.length-1;a>=0;a--)e[n].splice(i,0,t[n].$each[a]);o>0?e[n].splice(o,e[n].length-o):0===o?e[n].length=0:o<0&&e[n].splice(0,e[n].length+o)}}}else e[n]||(e[n]={}),_update._push(e[n],t[n]);return e},_apply:function(e,t,n){var r,i,o;for(r in t)if(!_.isArray(t[r])&&_.isObject(t[r])){if(!(e[r]||"$rename"!==n&&"$unset"!==n&&"$pop"!==n))break;e[r]||(e[r]={}),_update._apply(e[r],t[r],n)}else if(hasOwnProperty.call(t,r))switch(n){case"$inc":"number"==typeof e[r]?e[r]+=t[r]:e[r]=t[r];break;case"$mul":"number"==typeof e[r]?e[r]*=t[r]:e[r]=0;break;case"$rename":e[r]&&(e[t[r]]=e[r],delete e[r]);break;case"$set":_.isArray(t[r])?e[r]=_.clone(t[r]):e[r]=t[r];break;case"$unset":e[r]&&delete e[r];break;case"$min":(!e[r]||"number"==typeof e[r]&&t[r]<e[r])&&(e[r]=t[r]);break;case"$max":(!e[r]||"number"==typeof e[r]&&t[r]>e[r])&&(e[r]=t[r]);break;case"$pop":_.isArray(e[r])&&(1===t[r]?e[r].pop():t[r]===-1&&e[r].shift());break;case"$pullAll":if(_.isArray(e[r])&&_.isArray(t[r]))for(i=0;i<t[r].length;i++)for(o=e[r].length-1;o>=0;o--)e[r][o]===t[r][i]&&e[r].splice(o,1);break;default:throw new Error('_update._apply: the operator "'+n+'" is unknown!')}return e},_replace:function(e,t){var n,r=_.keys(e);for(n=0;n<r.length;n++)"_id"!==r[n]&&delete e[r[n]];return _.extend(e,t)},_applyTime:function(e,t){var n,r;for(n in t)({}).hasOwnProperty.call(t,n)&&(r=_.keys(t[n])[0],_.isObject(t[n])&&"$type"!==r?(e[n]||(e[n]={}),_update._applyTime(e[n],t[n])):hasOwnProperty.call(t,n)&&("timestamp"===t[n][r]?e[n]=Date.now():e[n]=(new Date).toISOString()));return e},_updateThisDoc:function(e,t){var n=_.keys(t);if(!n[0].match(/^\$/))return _update._replace(e,t);switch(n[0]){case"$inc":return _update._apply(e,t.$inc,"$inc");case"$mul":return _update._apply(e,t.$mul,"$mul");case"$rename":return _update._apply(e,t.$rename,"$rename");case"$set":return _update._apply(e,t.$set,"$set");case"$unset":return _update._apply(e,t.$unset,"$unset");case"$min":return _update._apply(e,t.$min,"$min");case"$max":return _update._apply(e,t.$max,"$max");case"$currentDate":return _update._applyTime(e,t.$currentDate);case"$pop":return _update._apply(e,t.$pop,"$pop");case"$pullAll":return _update._apply(e,t.$pullAll,"$pullAll");case"$pull":return _update._pull(e,t.$pull,"$pull");case"$push":return _update._push(e,t.$push,"$push");default:throw new Error('The Update Operator "'+n[0]+"\" isn't supported!")}},_update:function(e,t,n,r,i,o){var a,s,u=_query.isHavingSpecialOperator(n);if(_.isArray(n)||_.isFunction(n)||!_.isObject(n))return void(o&&o("filter is not a valid object!"));if(_.isArray(r)||_.isFunction(r)||!_.isObject(r))return void(o&&o("update is not a valid object!"));for(a=[],s=0;s<e.data.length&&(!_query.isMatch(e.data[s],n,u)||(_update._updateThisDoc(e.data[s],r),a.push(_.extend({},e.data[s])),i.many));s++);_event.fire(t,"change",a),_event.fire(t,"update",a),o&&o(null,a)},update:function(e,t,n,r,i,o){var a=e.db,s=e.eventQ;o&&!_.isFunction(o)?o=void 0:o||_.isFunction(i)?!o&&_.isFunction(i)&&(o=i,i={}):o=void 0,!_.isArray(i)&&_.isObject(i)||(i={}),i.many=t,_update._update(a,s,n,r,i,o)}};var _init=function(e){e.db=_insert._schema(),e.eventQ=_event.setEventListenerList()};return PicoDB.Create=function(){this.db;var _export=function(name){return eval(name)},count=function(e,t,n){!this.db||arguments.length<1||_count.count(this,e,t,n)},deleteMany=function(e,t,n){!this.db||arguments.length<1||_delete.delete(this,!0,e,t,n)},deleteOne=function(e,t,n){!this.db||arguments.length<1||_delete.delete(this,!1,e,t,n)},insertMany=function(e,t,n){this.db||_init(this),arguments.length<1||_insert.insert(this,!0,e,t,n)},insertOne=function(e,t,n){this.db||_init(this),arguments.length<1||_insert.insert(this,!1,e,t,n)},updateMany=function(e,t,n,r){!this.db||arguments.length<2||_update.update(this,!0,e,t,n,r)},updateOne=function(e,t,n,r){!this.db||arguments.length<2||_update.update(this,!1,e,t,n,r)},find=function(e,t){return e=e||{},t=t||{},this.db?(_find.find(this,e,t),this):this},toArray=function(e){this.db&&_find.toArray(this,e)},addEventListener=function(e,t){this.db||_init(this),_event.addEventListener(this.eventQ,e,t)},addOneTimeEventListener=function(e,t){this.db||_init(this),_event.addOneTimeEventListener(this.eventQ,e,t)},removeEventListener=function(e,t){this.db||_init(this),_event.removeEventListener(this.eventQ,e,t)};return{_export:_export,count:count,deleteMany:deleteMany,deleteOne:deleteOne,insertMany:insertMany,insertOne:insertOne,updateMany:updateMany,updateOne:updateOne,find:find,toArray:toArray,addEventListener:addEventListener,addOneTimeEventListener:addOneTimeEventListener,removeEventListener:removeEventListener,on:addEventListener,one:addOneTimeEventListener,off:removeEventListener}},PicoDB});